<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#88cfd3" />
  <title>ã‚¦ã‚¯ãƒ¬ãƒ¬ãƒ»ã‚²ãƒ¼ãƒ </title>
  <style>/* iphone-viewport-fix */

    :root{
      --vh: 1vh;

      --primary: #ff7a3d;
      --card: rgba(255,255,255,0.92);
      --shadow: rgba(0,0,0,0.18);
    }
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
      background: linear-gradient(to bottom, #7ab1cc 0%, #a8e6cf 100%);
      color: #4a3728;
      font-family: system-ui, -apple-system, sans-serif;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    #app { position: fixed; inset: 0; width: 100%; height: 100dvh; height: calc(var(--vh) * 100); overflow: hidden; padding-top: env(safe-area-inset-top); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); padding-bottom: env(safe-area-inset-bottom); box-sizing: border-box; }
    canvas { display:block; width:100%; height:100%; touch-action:none; }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #menu-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.32);
      display: flex; align-items: center; justify-content: center;
      z-index: 100; backdrop-filter: blur(2px);
    }
    .menu-card {
      background: var(--card); width: min(560px, 96vw);
      max-height: calc(100% - 24px); overflow-y: auto;
      border-radius: 18px; padding: 18px;
      box-shadow: 0 12px 0 rgba(122,177,204,0.35), 0 18px 36px var(--shadow);
      display: flex; flex-direction: column; gap: 10px;
    }
    .menu-card h1 { margin: 0 0 6px; font-size: 22px; text-align: center; }
    
    .menu-btn {
      background: rgba(255,255,255,0.98); color: #4a3728;
      border: none; border-radius: 16px; padding: 12px;
      cursor: pointer; display: flex; gap: 12px; align-items: center;
      box-shadow: 0 4px 0 rgba(122,177,204,0.32);
      transition: transform 0.08s; text-align: left;
    }
    .menu-btn:active { transform: translateY(2px); box-shadow: none; }
    .badge { flex: 0 0 38px; height: 38px; border-radius: 12px; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; }
    .menu-btn.mode2 .badge{ background: #ffde59; color:#4a3728; }
    .menu-btn.mode3 .badge{ background: #7ed957; }
    .menu-btn.mode4 .badge{ background: #5ce1e6; color: #133; }
    
    .menu-text .title { font-size: 16px; font-weight: 900; margin-bottom: 2px; }
    .menu-text small { font-size: 11px; opacity: 0.8; }

    /* ãƒ¢ãƒ¼ãƒ‰é¸æŠ */
    .mode-select { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); }
    .mode-pills { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    .mode-pill {
      border: 2px solid rgba(0,0,0,0.1); background: #fff; border-radius: 20px;
      padding: 6px 12px; font-weight: 800; font-size:10px; cursor: pointer;
    }
    .mode-pill.active { border-color: var(--primary); background: rgba(255,122,61,0.1); color: var(--primary); }

    /* ã‚²ãƒ¼ãƒ UI */
    #score-panel, #timer-panel {
      position: fixed; z-index: 90; background: rgba(255,255,255,0.85);
      padding: 6px 12px; border-radius: 14px; font-weight: 900; font-size: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;
    }
    #score-panel { top: calc(60px + var(--ui-top, 0px) + env(safe-area-inset-top)); right: calc(12px + var(--ui-right, 0px) + env(safe-area-inset-right)); }
    #timer-panel { top: calc(12px + env(safe-area-inset-top)); right: calc(12px + env(safe-area-inset-right)); font-size: 16px; }

    #stopBtn {
      position: fixed; right: calc(14px + env(safe-area-inset-right)); bottom: calc(14px + env(safe-area-inset-bottom)); z-index: 180; display: none;
      border: none; border-radius: 16px; padding: 12px 18px;
      background: rgba(255,255,255,0.92); font-weight: 900; font-size: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15); cursor: pointer;
    }
    
    #back-btn {
      position: fixed; top: 12px; left: 12px; z-index: 180;
    }
    #back-btn button {
      border: none; background: rgba(255,255,255,0.6); color: #0d2b3b;
      font-weight: 800; font-size: 12px; padding: 8px 12px; border-radius: 10px; cursor: pointer;
    }

    #chordHud {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      z-index: 85; display: none; pointer-events: none;
      background: rgba(255,255,255,0.86); border-radius: 18px; padding: 6px 16px;
      font-weight: 900; font-size: 32px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    #lyrics-area {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 90%;
      text-align: center; font-size: 28px; font-weight: 900; color: #4a3728;
      text-shadow: 0 2px 8px rgba(255,255,255,0.8); pointer-events: none; z-index: 50;
    }

    /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…±é€š */
    .overlay-card {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      z-index: 120; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
    }
    .card-content {
      background: #fff; width: min(480px, 90vw); border-radius: 20px; padding: 24px;
      text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative;
    }
    .result-score { font-size: 32px; font-weight: 900; margin: 10px 0; color: var(--primary); }
    .action-btn {
      width: 100%; border: none; border-radius: 14px; padding: 14px; font-size: 16px; font-weight: 900;
      cursor: pointer; margin-top: 10px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-secondary { background: #eee; color: #555; }

    @media (orientation: landscape) and (max-height: 460px) {
      .menu-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .menu-btn { padding: 8px; }
    }
  
    /* FX message (HIT / MISS / SPEED) - comic style (center / bigger) */
#fxMsg{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) rotate(-4deg) scale(1);
  z-index: 95;
  display: none;
  pointer-events: none;
  padding: 14px 20px 16px;
  border-radius: 18px;
  background: rgba(255,255,255,0.96);
  border: 4px solid #111;
  box-shadow: 0 16px 40px rgba(0,0,0,0.28);
  font-weight: 1000;
  font-size: 48px;
  text-align: center;
  letter-spacing: 0.8px;
  white-space: pre-line;
  line-height: 1.02;
  color: #ff3d00;
  text-shadow:
    0 3px 0 #111,
    2px 2px 0 #111,
    -2px 2px 0 #111,
    2px -2px 0 #111,
    -2px -2px 0 #111,
    0 10px 20px rgba(0,0,0,0.22);
}
#fxMsg.hit{ color: #ff3d00; }
#fxMsg.miss{ color: #2563eb; background: rgba(207,232,255,0.96); }
#fxMsg.speed{ color: #0a7f4f; background: rgba(186,247,214,0.96); }
#fxMsg.mega{
  font-size: 68px;
  transform: translate(-50%, -50%) rotate(-6deg) scale(1);
}
@keyframes fxComicPop {
  0%   { transform: translate(-50%, -50%) rotate(-4deg) scale(0.72); opacity: 0; }
  20%  { transform: translate(-50%, -50%) rotate(-6deg) scale(1.22); opacity: 1; }
  55%  { transform: translate(-50%, -50%) rotate(-2deg) scale(1.02); opacity: 1; }
  100% { transform: translate(-50%, -50%) rotate(1deg)  scale(1.00); opacity: 0; }
}
@keyframes fxShake {
  0% { }
  20%{ transform: translate(-50%, -50%) rotate(-7deg) translateX(-2px); }
  40%{ transform: translate(-50%, -50%) rotate(-3deg) translateX(3px); }
  60%{ transform: translate(-50%, -50%) rotate(-8deg) translateX(-3px); }
  80%{ transform: translate(-50%, -50%) rotate(-2deg) translateX(2px); }
  100%{ }
}
#fxMsg.show{
  display: block;
  animation: fxComicPop 0.98s ease-out forwards, fxShake 0.5s ease-out;
}

/* BIG COMBO (neck center) */
#comboBig{
  position: fixed;
  left: 50%;
  top: calc(50% + 66px);
  transform: translate(-50%, -50%) rotate(-2deg);
  z-index: 94;
  display: none;
  pointer-events: none;
  font-weight: 1000;
  font-size: 54px;
  color: rgba(255,255,255,0.92);
  text-shadow:
    0 4px 0 #111,
    2px 2px 0 #111,
    -2px 2px 0 #111,
    2px -2px 0 #111,
    -2px -2px 0 #111,
    0 14px 26px rgba(0,0,0,0.25);
  letter-spacing: 0.6px;
  white-space: nowrap;
}
#comboBig.pulse{
  animation: comboPulse 0.38s ease-out;
}
@keyframes comboPulse{
  0%{ transform: translate(-50%, -50%) rotate(-2deg) scale(0.95); opacity: 0.0; }
  40%{ transform: translate(-50%, -50%) rotate(-2deg) scale(1.18); opacity: 1.0; }
  100%{ transform: translate(-50%, -50%) rotate(-2deg) scale(1.0); opacity: 0.95; }
}

/* SCREEN FLASH (milestone) */
#screenFlash{
  position: fixed;
  inset: 0;
  z-index: 93;
  display: none;
  pointer-events: none;
  background: rgba(255,255,255,0.0);
}
#screenFlash.flash{
  display: block;
  animation: flashPop 0.34s ease-out forwards;
}
@keyframes flashPop{
  0%{ background: rgba(255,255,255,0.0); }
  15%{ background: rgba(255,255,255,0.55); }
  100%{ background: rgba(255,255,255,0.0); }
}

/* COMBO panel (keep but hide: replaced by comboBig) */
#combo-panel{ display:none !important; }

    /* comboBig disabled (show combo only in FX) */
    #comboBig{ display:none !important; }
  
  .verBadge{
  position:fixed;
  top:calc(8px + env(safe-area-inset-top));
  left:calc(8px + env(safe-area-inset-left));
  right:auto;
  bottom:auto;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(0,0,0,0.45);
  color:#fff;
  font-weight:800;
  font-size:12px;
  letter-spacing:.3px;
  z-index:9999;
  pointer-events:none;
  user-select:none;
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
}

  body:not(.isMenu) .verBadge{ display:none; }

/* === PAGE_FLIP_TRANSITION v1 (shared) === */
#pageFlip{
  position: fixed;
  inset: 0;
  z-index: 99999;
  pointer-events: none;
  display: none;
  perspective: 900px;
}
#pageFlip::before{
  content:"";
  position:absolute;
  inset: -6vh -8vw;
  background:
    linear-gradient(90deg,
      rgba(255,255,255,0.00) 0%,
      rgba(255,255,255,0.65) 35%,
      rgba(255,255,255,0.98) 62%,
      rgba(255,255,255,1.00) 100%);
  box-shadow: -18px 0 45px rgba(0,0,0,0.18);
  transform-origin: right center;
  transform: translateX(110%) rotateY(-35deg);
  border-left: 1px solid rgba(0,0,0,0.08);
}
#pageFlip.run::before{
  animation: pageFlipIn 320ms ease-out forwards;
}
@keyframes pageFlipIn{
  0%   { transform: translateX(110%) rotateY(-35deg); opacity: 0.0; }
  25%  { opacity: 1.0; }
  100% { transform: translateX(0%) rotateY(0deg); opacity: 1.0; }
}
@media (prefers-reduced-motion: reduce){
  #pageFlip.run::before{ animation: none; transform: translateX(0) rotateY(0); opacity: 1; }
}

</style>
</head>
<body>

<div id="app">
  <div id="menu-overlay">
    <div class="menu-card">
      <h1 style="margin-bottom: 2px;">ğŸª• ã‚²ãƒ¼ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>
      
      <div class="menu-list" style="display:flex; flex-direction:column; gap:8px;">
        <button class="menu-btn mode1" onclick="prepGame('scale')">
          <div class="badge">ğŸ¤</div>
          <div class="menu-text"><div class="title">ãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚½ãƒ©ã‚·ãƒ‰</div><small>ã ã‚“ã ã‚“é€Ÿããªã‚‹ã‚ˆ</small></div>
        </button>
        <button class="menu-btn mode2" onclick="prepGame('easy')">
          <div class="badge">ğŸ±</div>
          <div class="menu-text"><div class="title">ã‚³ãƒ¼ãƒ‰ ã‹ã‚“ãŸã‚“</div><small>C / F / G7 / Am</small></div>
        </button>
        <button class="menu-btn mode3" onclick="prepGame('hard')">
          <div class="badge">ğŸ¼</div>
          <div class="menu-text"><div class="title">ã‚³ãƒ¼ãƒ‰ ã¡ã‚‡ã„ã‚€ãš</div><small>ã„ã‚ã„ã‚ãªã‚³ãƒ¼ãƒ‰</small></div>
        </button>
        <button class="menu-btn mode4" onclick="prepGame('song')">
          <div class="badge">ğŸ¦</div>
          <div class="menu-text"><div class="title">æ›²ï¼šãã‚‰ãã‚‰æ˜Ÿ</div><small>ãƒ¡ãƒ­ãƒ‡ã‚£ï¼‹ã‚³ãƒ¼ãƒ‰</small></div>
        </button>
      </div>

      <div class="mode-select">
        <div class="mode-pills">
          <div class="mode-pill" data-mode="NORMAL" onclick="setMode(this, 'NORMAL')">ãƒãƒ¼ãƒãƒ«</div>
          <div class="mode-pill active" data-mode="WAIT" onclick="setMode(this, 'WAIT')">ã¾ã¡ãƒ¢ãƒ¼ãƒ‰</div>
          <div class="mode-pill" data-mode="TAP" onclick="setMode(this, 'TAP')">ã‚¿ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰</div>
        </div>
      </div>
      
      <button class="action-btn btn-secondary" onclick="goFlip('index.html')" style="margin-top:10px;">ğŸï¸ TOPã¸ã‚‚ã©ã‚‹</button>
    </div>
  </div>

  <div id="screenFlash"></div>
  <div id="fxMsg"></div>
  <div id="comboBig"></div>

  <div id="lyrics-area"></div>
  <div id="combo-panel"><div class="t1">COMBO</div><div class="t2"><span id="comboNum">0</span> é€£ç¶š</div></div>
  <div id="score-panel">â­ <span id="score">0</span></div>
  <div id="timer-panel">ã®ã“ã‚Š <span id="timer">60</span> ç§’</div>
  <div id="chordHud" aria-hidden="true"></div>
  
  <div id="back-btn"><button onclick="goMenu()">ğŸï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button></div>
  <button id="stopBtn" type="button">ã‚¹ãƒˆãƒƒãƒ—</button>

  <div id="loading-overlay" class="overlay-card">
    <div class="card-content">
      <h2>ãƒã‚¤ã‚¯ã˜ã‚…ã‚“ã³ä¸­...</h2>
      <p id="loading-msg">é™ã‹ã«ã—ã¦ã­ï¼ˆãƒã‚¤ã‚ºã‚’ã¯ã‹ã£ã¦ã„ã¾ã™ï¼‰</p>
    </div>
  </div>

  <div id="pause-overlay" class="overlay-card">
    <div class="card-content">
      <h2>ã‚¹ãƒˆãƒƒãƒ—ä¸­</h2>
      <button class="action-btn btn-primary" onclick="resumeGame()">ã¤ã¥ã‘ã‚‹</button>
      <button class="action-btn btn-secondary" onclick="goMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
    </div>
  </div>

  <div id="result-overlay" class="overlay-card">
    <div class="card-content">
      <h2>Finish!</h2>
      <div class="result-score">â­ <span id="result-score">0</span> pts</div>
      <p id="result-msg">Good Job!</p>
      <button class="action-btn btn-primary" onclick="restartLast()">ã‚‚ã†ï¼‘å›</button>
      <button class="action-btn btn-secondary" onclick="goMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>
</div>

<script>
// ===== åŸºæœ¬è¨­å®š =====
const BASE_SPEED_MULT = 1.5; // å…¨ä½“ã®ãƒ™ãƒ¼ã‚¹é€Ÿåº¦å€ç‡
const SPEEDUP_MULT = 1.7;     // ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—å€ç‡

const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// ===== SHARED_STAGE_BLOCK v1 (GAME/TUNING å…±é€š) =====
// ç›®çš„: ãƒãƒƒã‚¯/å¼¦/ãƒ•ãƒ¬ãƒƒãƒˆã®ã€Œåº§æ¨™ã¨è¦‹ãŸç›®ã€ã‚’1ã‹æ‰€ã§å›ºå®šã—ã€ã‚ºãƒ¬å†ç™ºã‚’é˜²ãã€‚
// æ³¨æ„: ã“ã“ã¯åŸå‰‡ã„ã˜ã‚‰ãªã„ï¼ˆå¤‰æ›´ã™ã‚‹ã¨ game/tuning ä¸¡æ–¹ã«å½±éŸ¿ï¼‰ã€‚
const STAGE = Object.freeze({
  NUT_X: 150,
  NECK_HALF_H: 130,
  NECK_H: 260,
  FRET_COUNT: 12,
  FRET_RIGHT_PAD: 20,        // (canvas.width - NUT_X - PAD)/FRET_COUNT
  LANE_DY: 75,
  LABEL_X: 110,
  LABEL_R: 22,
  NUT_LINE_W: 10,
  FRET_LINE_W: 3,
  STRING_LINE_W: 6,
  NUT_COLOR: "#eee",
  FRET_COLOR: "#a1887f",
  FRET_MARK_COLOR: "#c9b7ae",
  FRET_MARK_W_MULT: 1.3,
  INLAY_COLOR: "rgba(255,255,255,0.28)",
  INLAY_STROKE: "rgba(0,0,0,0.15)",
  INLAY_R: 6,
  INLAY_DY: 16,
  NECK_COLOR: "#6d4c41",
  LABEL_FONT: "bold 16px sans-serif",
  NUT_BLOCK_W: 18,
  NUT_BLOCK_OVER: 6,
  FRET_HINTS: Object.freeze([1,3,5,7,10,12]),
  FRET_HINT_FONT: "700 13px sans-serif",
  FRET_HINT_COLOR: "rgba(255,255,255,0.62)",
  FRET_HINT_Y_PAD:  2,
});

function stageGeom(canvas){
  const cy = canvas.height/2;
  const nutX = STAGE.NUT_X;
  const fretW = (canvas.width - nutX - STAGE.FRET_RIGHT_PAD) / STAGE.FRET_COUNT;
  const y = cy - STAGE.NECK_HALF_H;
  const h = STAGE.NECK_H;
  return { cy, nutX, fretW, y, h };
}

function rrRect(ctx,x,y,w,h,r){
  r = Math.max(0, Math.min(r, w/2, h/2));
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}

function drawFretboardBase(ctx, canvas, stringColors){
  const g = stageGeom(canvas);
  const { cy, nutX, fretW } = g;

  // neck
  ctx.fillStyle = STAGE.NECK_COLOR;
  // main neck (from nut to right)
  ctx.fillRect(nutX, cy - STAGE.NECK_HALF_H, canvas.width - nutX, STAGE.NECK_H);

  // nut block (clearly visible)
  (function(){
    const nutW = STAGE.NUT_BLOCK_W;
    const over = STAGE.NUT_BLOCK_OVER;
    const x0 = nutX - nutW/2;
    const y0 = cy - STAGE.NECK_HALF_H - over;
    const h0 = STAGE.NECK_H + over*2;
    ctx.save();
    ctx.shadowColor = "rgba(0,0,0,0.25)";
    ctx.shadowBlur = 6;
    ctx.fillStyle = STAGE.NUT_COLOR;
    rrRect(ctx, x0, y0, nutW, h0, 6);
    ctx.fill();
    ctx.restore();
    // outline
    ctx.strokeStyle = "rgba(0,0,0,0.25)";
    ctx.lineWidth = 2;
    rrRect(ctx, x0, y0, nutW, h0, 6);
    ctx.stroke();
  })();

// frets (1..10)  â€» inlayæç”»ãŒãƒ‘ã‚¹ã‚’æ½°ã•ãªã„ã‚ˆã†ã€å…ˆã«ãƒ•ãƒ¬ãƒƒãƒˆç·šã‚’strokeã—ã¦ã‹ã‚‰ã‚¤ãƒ³ãƒ¬ã‚¤ã‚’æã
  for (let i=1; i<=STAGE.FRET_COUNT; i++){
    const x = nutX + g.fretW * i;
    const isMark = (i===5 || i===10);

    ctx.strokeStyle = isMark ? STAGE.FRET_MARK_COLOR : STAGE.FRET_COLOR;
    ctx.lineWidth = STAGE.FRET_LINE_W * (isMark ? STAGE.FRET_MARK_W_MULT : 1);

    ctx.beginPath();
    ctx.moveTo(x, g.y);
    ctx.lineTo(x, g.y + g.h);
    ctx.stroke();

    // inlays: 5F=1dot, 10F=2dotï¼ˆåŒã˜â—â—ï¼‰
    if(i===5){
      ctx.save();
      ctx.fillStyle = STAGE.INLAY_COLOR;
      ctx.strokeStyle = STAGE.INLAY_STROKE;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(x, cy, STAGE.INLAY_R, 0, Math.PI*2);
      ctx.fill();
      ctx.stroke();
      ctx.restore();
    }else if(i===10){
      ctx.save();
      ctx.fillStyle = STAGE.INLAY_COLOR;
      ctx.strokeStyle = STAGE.INLAY_STROKE;
      ctx.lineWidth = 1;
      const dy = STAGE.INLAY_DY;
      for(const yy of [cy - dy, cy + dy]){
        ctx.beginPath();
        ctx.arc(x, yy, STAGE.INLAY_R, 0, Math.PI*2);
        ctx.fill();
        ctx.stroke();
      }
      ctx.restore();
    }
  }

  // teacher fret hints (inside neck top edge)
  (function(){
    ctx.save();
    const born = (window.__fretHintBorn ?? (window.__fretHintBorn = performance.now()));
    const dt = performance.now() - born;
    // brief "noticeable" pulse on load, then settle subtle
    const boost = dt < 900 ? (2.2 - 1.2*(dt/900)) : 1.0;

    ctx.font = STAGE.FRET_HINT_FONT;
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    const yTxt = g.y + STAGE.FRET_HINT_Y_PAD;

    const baseA = 0.65; // keep subtle but readable
    ctx.globalAlpha = Math.min(1, baseA * boost);

    // outline for readability on brown neck
    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(0,0,0,0.28)";
    ctx.fillStyle = STAGE.FRET_HINT_COLOR;

    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(0,0,0,0.18)";
    for (const n of STAGE.FRET_HINTS){
      if (n < 1 || n > STAGE.FRET_COUNT) continue;
      const x = nutX + g.fretW * n;
      const s = String(n);
      ctx.strokeText(s, x, yTxt);
      ctx.strokeText(s, x, yTxt);
      ctx.fillText(s, x, yTxt);
      }
    ctx.restore();
  })();

// strings + left labels
  const labs = ['1A','2E','3C','4G'];
  for(let i=0;i<4;i++){
    const y = cy + (i-1.5) * STAGE.LANE_DY;

    // left circle
    ctx.beginPath();
    ctx.fillStyle = stringColors[i];
    ctx.globalAlpha = 1.0;
    ctx.arc(STAGE.LABEL_X, y, STAGE.LABEL_R, 0, Math.PI*2);
    ctx.fill();

    // label text
    ctx.fillStyle = "#fff";
    ctx.font = STAGE.LABEL_FONT;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(labs[i], STAGE.LABEL_X, y);

    // straight string (tuning will overdraw as vibration if needed)
    ctx.strokeStyle = stringColors[i];
    ctx.lineWidth = STAGE.STRING_LINE_W;
    ctx.beginPath();
    ctx.moveTo(nutX, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }

  // restore defaults for other drawing
  ctx.textAlign = "start";
  ctx.textBaseline = "alphabetic";

  return g; // {cy,nutX,fretW}
}
// ===== /SHARED_STAGE_BLOCK v1 =====



// --- UI safe-area for browser bars (no install required) ---
function updateUiVars(){
  const vv = window.visualViewport;
  if(vv){
    const top = Math.max(0, vv.offsetTop||0);
    const left = Math.max(0, vv.offsetLeft||0);
    const right = Math.max(0, (window.innerWidth - vv.width - left));
    const bottom = Math.max(0, (window.innerHeight - vv.height - top));
    document.documentElement.style.setProperty('--ui-top', Math.round(top)+'px');
    document.documentElement.style.setProperty('--ui-left', Math.round(left)+'px');
    document.documentElement.style.setProperty('--ui-right', Math.round(right)+'px');
    document.documentElement.style.setProperty('--ui-bottom', Math.round(bottom)+'px');
  } else {
    document.documentElement.style.setProperty('--ui-top','0px');
    document.documentElement.style.setProperty('--ui-left','0px');
    document.documentElement.style.setProperty('--ui-right','0px');
    document.documentElement.style.setProperty('--ui-bottom','0px');
  }
}
updateUiVars();
if(window.visualViewport){
  window.visualViewport.addEventListener('resize', updateUiVars);
  window.visualViewport.addEventListener('scroll', updateUiVars);
}
window.addEventListener('resize', updateUiVars);
window.addEventListener('orientationchange', ()=>setTimeout(updateUiVars, 250));


let gameState = 'MENU';
let playMode = 'WAIT';

// ãƒã‚¤ã‚¯é–¢é€£
let audioCtx = null;
let micStream = null;
let micAnalyser = null;

// ---- ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°çµæœï¼ˆåˆ¤å®šé–¾å€¤ï¼‰ã‚’èª­ã‚€ ----
const THRESH_KEY = 'uk_game_thresholds_v1';
const THRESH_MAX_AGE_H = 24; // 24æ™‚é–“
function loadGameThresholds(){
  try{
    const raw = localStorage.getItem(THRESH_KEY);
    if(!raw) return null;
    const o = JSON.parse(raw);
    if(!o || typeof o !== 'object') return null;
    if(!o.updatedAt) return null;
    const ageH = (Date.now() - Number(o.updatedAt)) / 3600000;
    if(!(ageH >= 0) || ageH > THRESH_MAX_AGE_H) return null;
    return o;
  }catch(e){ return null; }
}
async function measureNoiseRms(durationMs=900, stepMs=90){
  if(!micAnalyser) return 0;
  const buf = new Float32Array(micAnalyser.fftSize);
  const samples = [];
  const end = performance.now() + durationMs;
  while(performance.now() < end){
    micAnalyser.getFloatTimeDomainData(buf);
    let s=0; for(let i=0;i<buf.length;i++) s += buf[i]*buf[i];
    samples.push(Math.sqrt(s/buf.length));
    await new Promise(r=>setTimeout(r, stepMs));
  }
  samples.sort((a,b)=>a-b);
  const idx = Math.max(0, Math.min(samples.length-1, Math.floor(samples.length*0.85)));
  return samples[idx] ?? (samples[samples.length-1] ?? 0);
}
function applyThresholdsFrom(noise, stored){
  let rise = 0, high = 0;
  if(stored && typeof stored.pluckRiseRms === 'number' && typeof stored.pluckHighRms === 'number'){
    const baseNoise = (typeof stored.noiseRms==='number' && stored.noiseRms>0) ? stored.noiseRms : noise;
    const k = baseNoise>0 ? (noise/baseNoise) : 1;
    rise = stored.pluckRiseRms * k;
    high = stored.pluckHighRms * k;
  }
  // æœ€ä½ãƒ©ã‚¤ãƒ³ï¼ˆç«¯æœ«åˆ¥ï¼‰
  if(IS_IOS){
    rise = Math.max(rise||0, 0.0016, noise*2.0);
    high = Math.max(high||0, 0.0020, noise*3.0);
  } else {
    rise = Math.max(rise||0, 0.010,  noise*2.0);
    high = Math.max(high||0, 0.012,  noise*3.0);
  }
  if(high < noise*2.4) high = noise*2.4;
  if(rise > high*0.9) rise = high*0.6;
  PLUCK_RISE_RMS = rise;
  PLUCK_HIGH_RMS = high;
}

let prevRms = 0;
let pluckHoldCount = 0;
let ignorePluckUntil = 0;
let NOISE_RMS = 0;
let PLUCK_HIGH_RMS = 0.012; 
let PLUCK_RISE_RMS = 0.010;

// ã‚²ãƒ¼ãƒ å¤‰æ•°
let rafId = 0;
let gameEndAt = 0;
let score = 0;
let groups = [];
let stars = [];
const STAR_CAP = 90; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šé™ï¼ˆè»½é‡åŒ–ï¼‰ // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šé™
function burstStars(n, x, y, waves=1, waveDelay=120){
  const make = ()=>{
    const add = Math.min(n, STAR_CAP);
    for(let i=0;i<add;i++) stars.push(new Star(x,y));
    if(stars.length > STAR_CAP) stars.splice(0, stars.length-STAR_CAP);
  };
  make();
  for(let w=1; w<waves; w++) setTimeout(make, waveDelay*w);
}

let lastSpawn = 0;
let scrollSpeed = 3.5;
let baseScrollSpeed = 3.5;
let gameMode = 'practice';
let isSongMode = false;
let waitHold = false;
let waitTargetGroup = null;
let comboStreak = 0;
let speedLevel = 0; // æ—§ãƒ­ã‚¸ãƒƒã‚¯ç”¨ï¼ˆæ¸©å­˜ï¼‰
let speedBoosted = false;      // 5é€£ç¶š or 8éŸ³ãƒãƒ¼ãƒŸã‚¹ã§1.7å€ã«ã—ãŸã‹
let scaleSeqCount = 0;         // scaleã§ã€Œdoã‹ã‚‰do2ã¾ã§ã€ãƒãƒ¼ãƒŸã‚¹ã‚«ã‚¦ãƒ³ãƒˆ
let scaleSpeedBoosted = false; // scaleå°‚ç”¨
  updateComboUI();
  const big=document.getElementById('comboBig'); if(big) big.style.display='none';
let currentScrollSpeed = 3.5;
const SPEED_UP_EVERY = 5;    // 5é€£ç¶šã§åŠ é€Ÿ
const SPEED_STEP = 0.375;   // 1æ®µéšã®åŠ é€Ÿé‡ï¼ˆÃ—1.5ï¼‰
const SPEED_MAX_ADD = 2.25; // ä¸Šé™ï¼ˆÃ—1.5ï¼‰

let _fxTimer = 0;
const CHEER_PHRASES = ['ãã®èª¿å­ï¼','ã„ã„ãï¼','ãƒã£ã¦ã‚‹ï¼','ã‚­ã‚¿ãƒ¼ï¼','æœ€é«˜ï¼','ã¤ã¥ã‘ï¼','ã„ã‘ã‚‹ï¼'];
function flashScreen(){
  const f = document.getElementById('screenFlash');
  if(!f) return;
  f.classList.remove('flash');
  void f.offsetWidth;
  f.classList.add('flash');
}

function updateComboUI(){ /* disabled */ }
function showFx(text, kind, opts = {}){
  const el = document.getElementById('fxMsg');
  if(!el) return;
  el.textContent = text;
  el.classList.remove('hit','miss','speed','mega','show');
  el.style.display = 'block';
  if(kind) el.classList.add(kind);
  if(opts.mega) el.classList.add('mega');
  // restart animation (è»½é‡)
  requestAnimationFrame(()=>{ el.classList.add('show'); });
  clearTimeout(_fxTimer);
  _fxTimer = setTimeout(()=>{
    el.classList.remove('show','hit','miss','speed','mega');
    el.style.display = 'none';
  }, opts.durationMs || 980);
}

function resetSpeedState(){
  comboStreak = 0;
  speedLevel = 0;
  speedBoosted = false;
  scaleSeqCount = 0;
  scaleSpeedBoosted = false;
  currentScrollSpeed = baseScrollSpeed;
  if(gameState === 'PLAY' && !waitHold){
    scrollSpeed = currentScrollSpeed;
  }
}
function applySpeed(){
  const maxSpeed = baseScrollSpeed + SPEED_MAX_ADD;
  currentScrollSpeed = Math.min(baseScrollSpeed + speedLevel * SPEED_STEP, maxSpeed);
  if(gameState === 'PLAY' && !waitHold){
    scrollSpeed = currentScrollSpeed;
  }
}


// ãƒ‡ãƒ¼ã‚¿
const NUT_X = STAGE.NUT_X;
const STRING_COLORS = ['#ff5757', '#ffde59', '#7ed957', '#5ce1e6'];
const CHORD_LIB = {
  'C':  { name: 'C',  targetIdx: 0, fingers: [{s: 1, f: 3, txt: 'è–¬'}] },
  'F':  { name: 'F',  targetIdx: 0, fingers: [{s: 2, f: 1, txt: 'äºº'}, {s: 4, f: 2, txt: 'ä¸­'}] },
  'G7': { name: 'G7', targetIdx: 0, fingers: [{s: 2, f: 1, txt: 'äºº'}, {s: 1, f: 2, txt: 'ä¸­'}, {s: 3, f: 2, txt: 'è–¬'}] },
  'Am': { name: 'Am', targetIdx: 0, fingers: [{s: 3, f: 2, txt: 'ä¸­'}] },
  'G':  { name: 'G',  targetIdx: 0, fingers: [{s: 3, f: 2, txt: 'äºº'}, {s: 2, f: 3, txt: 'è–¬'}, {s: 1, f: 2, txt: 'ä¸­'}] },
  'A7': { name: 'A7', targetIdx: 0, fingers: [{s: 3, f: 1, txt: 'äºº'}] },
  'Dm': { name: 'Dm', targetIdx: 0, fingers: [{s: 4, f: 2, txt: 'ä¸­'}, {s: 3, f: 1, txt: 'äºº'}, {s: 2, f: 1, txt: 'äºº'}] },
  'Em': { name: 'Em', targetIdx: 0, fingers: [{s: 3, f: 4, txt: 'å°'}, {s: 2, f: 3, txt: 'è–¬'}, {s: 1, f: 2, txt: 'ä¸­'}] },
  'D7': { name: 'D7', targetIdx: 0, fingers: [{s: 2, f: 2, txt: 'ä¸­'}, {s: 3, f: 2, txt: 'è–¬'}, {s: 4, f: 2, txt: 'äºº'}] }
};
const SOLO_LIB = {
  'do':  { name:'ãƒ‰', targetIdx:0, fingers:[{s:3,f:0,txt:'0'}]},
  're':  { name:'ãƒ¬', targetIdx:0, fingers:[{s:3,f:2,txt:'ä¸­'}]},
  'mi':  { name:'ãƒŸ', targetIdx:0, fingers:[{s:2,f:0,txt:'0'}]},
  'fa':  { name:'ãƒ•ã‚¡', targetIdx:0, fingers:[{s:2,f:1,txt:'äºº'}]},
  'so':  { name:'ã‚½', targetIdx:0, fingers:[{s:2,f:3,txt:'è–¬'}]},
  'la':  { name:'ãƒ©', targetIdx:0, fingers:[{s:1,f:0,txt:'0'}]},
  'si':  { name:'ã‚·', targetIdx:0, fingers:[{s:1,f:2,txt:'ä¸­'}]},
  'do2': { name:'ãƒ‰', targetIdx:0, fingers:[{s:1,f:3,txt:'è–¬'}]}
};
const SONG_DATA = [
  {lib:CHORD_LIB,key:'C',lyrics:"ãã‚‰"},{lib:SOLO_LIB,key:'do',lyrics:""},
  {lib:CHORD_LIB,key:'C',lyrics:"ãã‚‰"},{lib:SOLO_LIB,key:'so',lyrics:""},
  {lib:CHORD_LIB,key:'F',lyrics:"ã²ã‹"},{lib:SOLO_LIB,key:'la',lyrics:""},
  {lib:CHORD_LIB,key:'C',lyrics:"ã‚‹ãƒ¼"},{lib:SOLO_LIB,key:'so',lyrics:""},
  {lib:CHORD_LIB,key:'G7',lyrics:"ãŠã"},{lib:SOLO_LIB,key:'fa',lyrics:""},
  {lib:CHORD_LIB,key:'C',lyrics:"ã‚‰ã®"},{lib:SOLO_LIB,key:'mi',lyrics:""},
  {lib:CHORD_LIB,key:'G7',lyrics:"ã»ã—"},{lib:SOLO_LIB,key:'re',lyrics:""},
  {lib:CHORD_LIB,key:'C',lyrics:"ã‚ˆãƒ¼"},{lib:SOLO_LIB,key:'do',lyrics:""}
];

let songIndex=0; let practiceIndex=0; let scaleIndex=0;
let currentLevelChords = [];
let spawnInterval = 2800; // â† é–“éš”ï¼ˆmsï¼‰: å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼å…±é€š
let lastStartParams = null; // ãƒªãƒˆãƒ©ã‚¤ç”¨

// --- UIæ“ä½œ ---
function setMode(el, mode){
  playMode = mode;
  document.querySelectorAll('.mode-pill').forEach(b => {
    const m = b.getAttribute('data-mode') || '';
    b.classList.toggle('active', m === mode);
  });
}

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ mode=TAP/NORMAL/WAIT ã‚’åæ˜ 
(function applyModeFromQuery(){
  try{
    const p = new URLSearchParams(location.search);
    const m = (p.get('mode')||'').toUpperCase();
    if(m==='TAP' || m==='NORMAL' || m==='WAIT'){
      setMode(null, m);
    }
  }catch(e){}
})();


// â˜…ä¿®æ­£: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹å‹•ä½œï¼ˆTOPã§ã¯ãªãã‚²ãƒ¼ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ï¼‰
function goMenu(){
  if(rafId) cancelAnimationFrame(rafId);
  gameState = 'MENU';
  try{ document.body.classList.add('isMenu'); }catch(e){}
  
  // UIãƒªã‚»ãƒƒãƒˆ
  document.getElementById('menu-overlay').style.display = 'flex';
  document.getElementById('score-panel').style.display = 'none';
  document.getElementById('timer-panel').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('pause-overlay').style.display = 'none';
  document.getElementById('result-overlay').style.display = 'none';
  document.getElementById('back-btn').style.display = 'none';
  document.getElementById('chordHud').style.display = 'none';
  document.getElementById('lyrics-area').innerText = '';
  
  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
  ctx.clearRect(0,0,canvas.width,canvas.height);
  resetSpeedState();
  const fx=document.getElementById('fxMsg'); if(fx){ fx.style.display='none'; fx.className=''; }
}

document.getElementById('stopBtn').onclick = () => {
  if(gameState==='PLAY') {
    gameState='PAUSE';
    document.getElementById('pause-overlay').style.display='flex';
  }
};
function resumeGame(){
  gameState='PLAY';
  try{ document.body.classList.remove('isMenu'); }catch(e){}
  document.getElementById('pause-overlay').style.display='none';
  lastFrameT=0; rafId=requestAnimationFrame(gameLoop);
}

// --- ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ•ãƒ­ãƒ¼ ---
async function prepGame(type){
  // ã‚¿ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ãƒã‚¤ã‚¯ä¸è¦
  if(playMode === 'TAP'){ startGameByType(type); return; }

  // ãƒã‚¤ã‚¯æº–å‚™
  document.getElementById('loading-overlay').style.display = 'flex';
  try {
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') await audioCtx.resume();

    if(!micStream){
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: IS_IOS ? { echoCancellation:false, noiseSuppression:false, autoGainControl:false } : true
      });
      const src = audioCtx.createMediaStreamSource(micStream);
      micAnalyser = audioCtx.createAnalyser();
      const gain = audioCtx.createGain();
      gain.gain.value = IS_IOS ? 3.9 : 1.0;
      micAnalyser.fftSize = IS_IOS ? 4096 : 2048;
      src.connect(gain).connect(micAnalyser);
    }

    // ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°çµæœï¼ˆã‚ã‚Œã°ï¼‰
    const stored = loadGameThresholds();

    // ãƒã‚¤ã‚ºè¨ˆæ¸¬ï¼ˆç´„1ç§’ï¼‰
    await new Promise(r => setTimeout(r, 200)); // ç«‹ã¡ä¸ŠãŒã‚Šå¾…ã¡
    NOISE_RMS = await measureNoiseRms(950, 95);

    // é–¾å€¤ï¼šãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°çµæœã‚’åŸºæœ¬ã«ã€ä»Šã®ãƒã‚¤ã‚ºåºŠã§è£œæ­£
    applyThresholdsFrom(NOISE_RMS, stored);

    document.getElementById('loading-overlay').style.display = 'none';
    startGameByType(type);

  } catch(e) {
    alert('ãƒã‚¤ã‚¯ãŒä½¿ãˆã¾ã›ã‚“ã€‚ã‚¿ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹ã—ã¾ã™ã€‚');
    playMode = 'TAP';
    document.getElementById('loading-overlay').style.display = 'none';
    startGameByType(type);
  }
}

function startGameByType(type){
  lastStartParams = type;
  if(type==='scale') initGame('scale', null, {speedBase:3.4});
  else if(type==='easy') initGame('practice', ['C','F','G7','Am'], {speedBase:3.2});
  else if(type==='hard') initGame('practice', ['C','F','G7','Am','G','A7','Dm','Em','D7'], {speedBase:3.35});
  else if(type==='song') initGame('song', 'ãã‚‰ãã‚‰æ˜Ÿ', {speedBase:3.45});
}

function restartLast(){
  document.getElementById('result-overlay').style.display='none';
  startGameByType(lastStartParams || 'easy');
}

function initGame(mode, levelData, opts){
  if(rafId) cancelAnimationFrame(rafId);
  gameState='PLAY';
  
  // UIãƒªã‚»ãƒƒãƒˆ
  document.getElementById('menu-overlay').style.display='none';
  document.getElementById('result-overlay').style.display='none';
  document.getElementById('score-panel').style.display='block';
  document.getElementById('timer-panel').style.display='block';
  document.getElementById('stopBtn').style.display='block';
  document.getElementById('back-btn').style.display='none'; // ã‚²ãƒ¼ãƒ ä¸­ã¯é‚ªé­”ãªã®ã§æ¶ˆã™

  // å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
  score=0; groups=[]; stars=[];
  waitHold=false; waitTargetGroup=null;
  baseScrollSpeed = (opts.speedBase || 3.5) * BASE_SPEED_MULT;
  currentScrollSpeed = baseScrollSpeed;
  scrollSpeed = currentScrollSpeed;
  resetSpeedState();
  gameMode = mode;
  isSongMode = (mode==='song');
  currentLevelChords = levelData || [];
  practiceIndex=0; scaleIndex=0; songIndex=0;
  spawnInterval = 2800; // å…¨ãƒ¢ãƒ¼ãƒ‰å…±é€šï¼ˆãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚‚æ›²ã‚‚ï¼‰

  document.getElementById('score').innerText="0";
  document.getElementById('lyrics-area').innerText="";
  gameEndAt = performance.now() + 60000;

  // æ„Ÿåº¦ãƒªã‚»ãƒƒãƒˆ
  prevRms = NOISE_RMS;
  pluckHoldCount=0; ignorePluckUntil=Date.now()+500;

  rafId = requestAnimationFrame(gameLoop);
}

// --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
let lastFrameT=0;
function gameLoop(time){
  if(gameState!=='PLAY') return;
  if(!lastFrameT) lastFrameT=time;
  lastFrameT=time;

  // ã‚¿ã‚¤ãƒãƒ¼
  if(!waitHold){
    const rem = Math.max(0, gameEndAt - performance.now());
    document.getElementById('timer').innerText = Math.ceil(rem/1000);
    if(rem<=0) { endGame(); return; }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawFretboard();

  // ã‚¹ãƒãƒ¼ãƒ³
  if(!waitHold && (time - lastSpawn > spawnInterval)){
    // ç”»é¢ãŒè©°ã¾ã‚‰ãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
    let cnt=0, maxX=-9999;
    for(let g of groups) { if(g.active){ cnt++; if(g.x>maxX) maxX=g.x; } }
    
    if(cnt<3 && (maxX < canvas.width+120 - 760)){ // â† ä½“æ„Ÿã§â€œé–“éš”ãŒåºƒã„â€ã‚ˆã†ã« spacing ã‚’å¼·åŒ–
      if(isSongMode){
        const d = SONG_DATA[songIndex % SONG_DATA.length];
        groups.push(new ChordGroup(d.lib[d.key], d.lyrics));
        songIndex++;
      } else if(gameMode==='scale'){
        const k = ['do','re','mi','fa','so','la','si','do2'][scaleIndex%8];
        const g = new ChordGroup(SOLO_LIB[k], "");
        g.noteKey = k;
        groups.push(g);
        scaleIndex++;
      } else {
        const k = currentLevelChords[practiceIndex % currentLevelChords.length];
        groups.push(new ChordGroup(CHORD_LIB[k], ""));
        practiceIndex++;
      }
      lastSpawn=time;
    }
  }

  // HUD & Draw
  let target=null, bestDist=Infinity;
  for(let g of groups){
    if(!g.active) continue;
    const d = Math.abs(g.x - NUT_X);
    if(d < bestDist && d < 620 + 100){ bestDist=d; target=g; }
  }
  if(target){
    if(gameMode!=='scale'){
      document.getElementById('chordHud').style.display='block';
      document.getElementById('chordHud').innerText = target.chord.name||'';
    } else {
      document.getElementById('chordHud').style.display='none';
    }
    // show faint support (also in scale mode)
    target.isTarget=true;
  } else {
    document.getElementById('chordHud').style.display='none';
  }

  for(let i=groups.length-1; i>=0; i--){
    groups[i].update(); groups[i].draw();
    if(groups[i].x < -300) groups.splice(i,1);
  }

  
  // è‡ªå‹•MISSï¼šåˆ¤å®šä½ç½®ã‚’é€šéã—ãŸã‚‰ï¼ˆã‚¿ãƒƒãƒ—ã—ãªãã¦ã‚‚ï¼‰MISSæ‰±ã„
  if(!waitHold && target && target.active){
    const win = 110; // handleActionã¨åŒã˜åˆ¤å®šçª“
    if(target.x < (NUT_X - win) && !target._autoMissed){
      target._autoMissed = true;

      // é€£ç¶šãƒ»é€Ÿåº¦ãƒªã‚»ãƒƒãƒˆï¼†MISSæ¼”å‡ºï¼ˆâ€œãŠã¡ã¤ã„ã¦â€ï¼‹flashï¼‰
      comboStreak = 0;
      resetSpeedState();
      updateComboUI();

      flashScreen();
      const missMsg = ['ãŠã¡ã¤ã„ã¦','ã ã„ã˜ã‚‡ã†ã¶ï¼','ã‚‚ã†ã„ã£ã‹ã„ï¼','ã‚†ã£ãã‚Šã§OK','ã‚ã‚ã¦ãªã„ï¼'][Math.floor(Math.random()*5)];
      showFx(missMsg, 'miss', { durationMs: 980 });
      burstStars(18, NUT_X, canvas.height/2, 1);

      if(playMode==='WAIT' || playMode==='TAP'){
        // å¾“æ¥ã©ãŠã‚Šï¼šæ­¢ã‚ã¦å¼¾ãç›´ã—ï¼ˆåŒã˜ç¬¦å·ã‚’æ­£è§£ä½ç½®ã§ç‚¹æ»…ï¼‰
        waitHold = true;
        scrollSpeed = 0;
        waitTargetGroup = target;
        target.x = NUT_X;
        target._autoMissed = false; // å¼¾ãç›´ã—ç”¨ã«è§£é™¤
      } else {
        // NORMALï¼šæµã—ã¦æ¬¡ã¸
        target.active = false;
      }
    }
  }

// ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  stars.forEach(s=>{ s.update(); s.draw(); });
  stars = stars.filter(s=>s.life>0);
  if(stars.length > STAR_CAP) stars.splice(0, stars.length-STAR_CAP);

  // ãƒã‚¤ã‚¯åˆ¤å®š
  processMicInput();

  rafId = requestAnimationFrame(gameLoop);
}

function endGame(){
  gameState='RESULT';
  cancelAnimationFrame(rafId);
  document.getElementById('result-score').innerText = score;
  document.getElementById('result-msg').innerText = score>300 ? "Amazing!!" : "Good Job!";
  document.getElementById('result-overlay').style.display='flex';
}

// --- å…¥åŠ›åˆ¤å®š ---
function processMicInput(){
  if(playMode==='TAP' || !micAnalyser) return;
  const buf = new Float32Array(micAnalyser.fftSize);
  micAnalyser.getFloatTimeDomainData(buf);
  let rms=0; for(let i=0; i<buf.length; i++) rms+=buf[i]*buf[i];
  const val = Math.sqrt(rms/buf.length);

  const rise = val - prevRms;
  const now = Date.now();
  if(now >= ignorePluckUntil && val > PLUCK_HIGH_RMS && rise > PLUCK_RISE_RMS){
    pluckHoldCount++;
  } else {
    pluckHoldCount = Math.max(0, pluckHoldCount-1);
  }
  prevRms = val;

  if(pluckHoldCount>=2){
    pluckHoldCount=0; ignorePluckUntil=now+250;
    handleAction();
  }
}

function handleAction(){
  if(gameState!=='PLAY') return;
  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ¢ç´¢
  let target=null, best=Infinity;
  if(waitHold && waitTargetGroup && waitTargetGroup.active){
    target = waitTargetGroup; best = Math.abs(target.x - NUT_X);
  } else {
    for(let g of groups){
      if(!g.active) continue;
      const d = Math.abs(g.x - NUT_X);
      if(d < 620 && d > -220){ if(d<best){ best=d; target=g; } }
    }
  }

  if(target){
    const win = 110;
    if(best < win){
      // HIT
      target.active=false;
      if(waitHold){
        waitHold=false; scrollSpeed=currentScrollSpeed; waitTargetGroup=null; lastSpawn=performance.now();
      }
      score += (best<50 ? 15 : 10);
      document.getElementById('score').innerText=score;
      burstStars(18, NUT_X, canvas.height/2, 1);
      // combo / speed (DDR6ãƒ«ãƒ¼ãƒ«)
      comboStreak++;
      updateComboUI();

      const cheer = CHEER_PHRASES[Math.floor(Math.random()*CHEER_PHRASES.length)];

      // ===== ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—åˆ¤å®š =====
      if(gameMode==='scale'){
        // scaleã¯ã€Œdoã‹ã‚‰do2ã¾ã§(8éŸ³)ã‚’ãƒãƒ¼ãƒŸã‚¹é”æˆã€ã§ã®ã¿1.7å€
        if(!scaleSpeedBoosted){
          if(target.noteKey === 'do'){
            scaleSeqCount = 1;
          } else if(scaleSeqCount > 0){
            scaleSeqCount++;
          } // else: doã‹ã‚‰å§‹ã¾ã£ã¦ã„ãªã„ã®ã§æ•°ãˆãªã„

          if(scaleSeqCount >= 8){
            scaleSpeedBoosted = true;
            currentScrollSpeed = baseScrollSpeed * SPEEDUP_MULT;
            if(gameState==='PLAY' && !waitHold) scrollSpeed = currentScrollSpeed;

            flashScreen();
            showFx(`ğŸ’¥ 8éŸ³ãƒãƒ¼ãƒŸã‚¹ï¼\nã‚¹ãƒ”ãƒ¼ãƒ‰UP!!`, 'speed', { mega:true, durationMs: 1200 });
            burstStars(55, canvas.width/2, canvas.height/2, 2, 140);
          } else {
            // é€šå¸¸HITï¼ˆscaleã§ã‚‚æ°—åˆ†ãŒä¸ŠãŒã‚‹è¨€è‘‰ã ã‘ï¼‰
            showFx(`âœ¨PERFECT!!âœ¨\n${comboStreak}é€£ç¶š  ${cheer}`, 'hit', { mega:false, durationMs: 880 });
            burstStars(12, canvas.width/2, canvas.height/2, 1);
          }
        } else {
          // æ—¢ã«åŠ é€Ÿä¸­
          showFx(`ğŸ”¥NICE!!ğŸ”¥\n${comboStreak}é€£ç¶š  ${cheer}`, 'hit', { mega:false, durationMs: 820 });
          burstStars(10, canvas.width/2, canvas.height/2, 1);
        }

      } else {
        // practice/songã¯ã€Œ5é€£ç¶šHITã§1.7å€ã€
        if(!speedBoosted && comboStreak >= 5){
          speedBoosted = true;
          currentScrollSpeed = baseScrollSpeed * SPEEDUP_MULT;
          if(gameState==='PLAY' && !waitHold) scrollSpeed = currentScrollSpeed;

          flashScreen();
          showFx(`ğŸ’¥ 5 COMBO!! ğŸ’¥\nã‚¹ãƒ”ãƒ¼ãƒ‰UP!!`, 'speed', { mega:true, durationMs: 1200 });
          burstStars(45, canvas.width/2, canvas.height/2, 2, 140);
        } else {
          const label = (best<50) ? 'âœ¨PERFECT!!âœ¨' : 'ğŸ”¥NICE!!ğŸ”¥';
          showFx(`${label}\n${comboStreak}é€£ç¶š  ${cheer}`, 'hit', { mega:false, durationMs: 900 });
          burstStars(14, canvas.width/2, canvas.height/2, 1);
        }
      }
} else {
      // MISSï¼ˆæ—©ã™ã/é…ã™ãï¼‰
      comboStreak = 0;
      resetSpeedState();
      updateComboUI();

      flashScreen();
      const missMsg = ['ãŠã¡ã¤ã„ã¦','ã ã„ã˜ã‚‡ã†ã¶ï¼','ã‚‚ã†ã„ã£ã‹ã„ï¼','ã‚†ã£ãã‚Šã§OK','ã‚ã‚ã¦ãªã„ï¼'][Math.floor(Math.random()*5)];
      showFx(missMsg, 'miss', { durationMs: 980 });
      burstStars(18, NUT_X, canvas.height/2, 1);

      if(playMode==='WAIT' || playMode==='TAP'){
        // å¾“æ¥ã©ãŠã‚Šï¼šæ­¢ã‚ã¦å¼¾ãç›´ã—
        if(!waitHold){
          waitHold=true; scrollSpeed=0; waitTargetGroup=target; target.x=NUT_X;
        }
      } else {
        // NORMALï¼šæµã—ã¦æ¬¡ã¸
        target.active=false;
      }
    }
  }
}


// --- æç”»ã‚¯ãƒ©ã‚¹ ---
class ChordGroup {
  constructor(chord, lyrics){
    this.chord=chord; this.lyrics=lyrics;
    this.x = canvas.width+120; this.active=true; this.ticked=false; this.isTarget=false;
  }
  update(){ this.x -= scrollSpeed; if(!this.ticked && this.x<=NUT_X){ if(this.lyrics) document.getElementById('lyrics-area').innerText=this.lyrics; this.ticked=true; } }
  draw(){
    if(!this.active) return;
    const cy = canvas.height/2;
    const fw = (canvas.width - NUT_X - STAGE.FRET_RIGHT_PAD) / STAGE.FRET_COUNT;
    
    // ã‚¬ã‚¤ãƒ‰ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ™‚ï¼‰
    if(this.isTarget && Math.abs(this.x-NUT_X)<620){
      const t = Math.max(0, 1 - Math.abs(this.x-NUT_X)/620);
      this.chord.fingers.forEach(f=>{
        const fx = f.f===0 ? NUT_X : NUT_X+(f.f*fw)-(fw/2);
        const fy = cy + (f.s-2.5)*75;
        drawCircle(fx, fy, f.txt, 32+t*10, 0.2+t*0.6, true);
      });
      this.isTarget=false;
    }
    // æœ¬ä½“
    const blink = (waitHold && waitTargetGroup===this) ? (0.5+0.5*Math.sin(performance.now()/100)) : 1.0;
    this.chord.fingers.forEach(f=>{
      const fx = f.f===0 ? this.x : this.x+(f.f*fw)-(fw/2);
      const fy = cy + (f.s-2.5)*75;
      drawCircle(fx, fy, f.txt, 40, 1.0, false, blink);
    });
    // ã‚¹ã‚±ãƒ¼ãƒ«å
    if(gameMode==='scale'){
      const tf = this.chord.fingers[0];
      const nx = tf.f===0 ? this.x : this.x+(tf.f*fw)-(fw/2);

      // iPhoneæ¨ªã§ã‚‚ä¸Šã§åˆ‡ã‚Œãªã„ã‚ˆã†ã€ãƒãƒƒã‚¯å†…ï¼ˆä¸Šç«¯ã‹ã‚‰å°‘ã—ä¸‹ï¼‰ã«å›ºå®š
      ctx.save();
      ctx.fillStyle="#fff";
      ctx.font="bold 50px sans-serif";
      ctx.textAlign="center";
      ctx.textBaseline="top";
      const neckTop = (canvas.height/2) - 150;
      const neckBottom = (canvas.height/2) + 150;
      const laneY = cy + (tf.s-2.5)*75;
      const circleR = 34;
      const fontSize = 50;
      // ã¾ãšã¯ã€ŒæŒ‡â—¯ã®ä¸Šã€ã«å‡ºã™ã€‚ä¸ŠãŒè¶³ã‚Šãªã‘ã‚Œã°ä¸‹ã¸ï¼ˆ1Aå¯¾ç­–ï¼‰
      let labelY = laneY - circleR - (fontSize + 8);
      if(labelY < neckTop + 8){
        labelY = laneY + circleR + 8;
      }
      // ã©ã“ã¾ã§è¡Œã£ã¦ã‚‚ãƒãƒƒã‚¯å¤–ã«å‡ºãªã„ã‚ˆã†ã«è»½ãã‚¯ãƒ©ãƒ³ãƒ—
      if(labelY > neckBottom - (fontSize + 8)){
        labelY = neckBottom - (fontSize + 8);
      }
      ctx.fillText(this.chord.name||"", nx, labelY);
      ctx.restore();
    }
}
}
function drawCircle(x,y,txt,size,alpha,blur,scale=1){
  ctx.save(); ctx.globalAlpha=alpha;
  if(blur) ctx.filter="blur(2px)";
  ctx.translate(x,y); ctx.scale(scale,scale);
  ctx.beginPath(); ctx.arc(0,0,size,0,Math.PI*2);
  ctx.fillStyle = (txt==='è–¬')?'#5271ff':(txt==='ä¸­'?'#ff66c4':(txt==='äºº'?'#ff914d':'#888'));
  ctx.fill(); ctx.strokeStyle="#fff"; ctx.lineWidth=4; ctx.stroke();
  ctx.filter="none"; ctx.fillStyle="#fff"; ctx.font=`bold ${size*0.75}px sans-serif`;
  ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(txt,0,2);
  ctx.restore();
}
class Star {
  constructor(x,y){ this.x=x;this.y=y;this.vx=(Math.random()-.5)*20;this.vy=(Math.random()-.5)*20;this.life=1; }
  update(){ this.x+=this.vx;this.y+=this.vy;this.vy+=0.5;this.life-=0.03; }
  draw(){ ctx.save();ctx.globalAlpha=this.life;ctx.fillStyle="#ffeb3b";ctx.beginPath();ctx.arc(this.x,this.y,6,0,Math.PI*2);ctx.fill();ctx.restore(); }
}

function drawFretboard(){
  drawFretboardBase(ctx, canvas, STRING_COLORS);
}


function applyViewportSize(){
  const vv = window.visualViewport;
  const w = vv ? vv.width  : (document.documentElement.clientWidth  || window.innerWidth);
  const h = vv ? vv.height : (document.documentElement.clientHeight || window.innerHeight);
  // expose CSS vh unit (iPhone Safari 100vh issue)
  document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
  canvas.width  = Math.floor(w);
  canvas.height = Math.floor(h);
}
applyViewportSize();
if (window.visualViewport){
  window.visualViewport.addEventListener('resize', applyViewportSize);
}
window.addEventListener('resize', applyViewportSize);
window.addEventListener('orientationchange', () => setTimeout(applyViewportSize, 250));
// ã‚¿ãƒƒãƒ—æ“ä½œ
canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); if(playMode==='TAP') handleAction(); }, {passive:false});
canvas.addEventListener('mousedown', ()=>{ if(playMode==='TAP') handleAction(); });

// UIBAR FIX PATCH (disabled on iOS)
(function(){
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  if (isIOS) return;
function nudge(){ try{ window.scrollTo(0, 1); }catch(e){} setTimeout(function(){ try{ window.scrollTo(0, 1); }catch(e){} }, 50); }
  window.addEventListener('touchstart', nudge, {passive:true});
  window.addEventListener('touchend',   nudge, {passive:true});
  window.addEventListener('click',      nudge, {passive:true});
  window.addEventListener('orientationchange', function(){ setTimeout(nudge, 250); }, {passive:true});
  window.addEventListener('pageshow', function(){ setTimeout(nudge, 250); }, {passive:true});
  setTimeout(nudge, 300);

})();

// __setMenuClassInit
try{ document.body.classList.add('isMenu'); }catch(e){}


/* === PAGE_FLIP_TRANSITION v1 (shared) === */
let __navLock = false;
function goFlip(url){
  if(__navLock) return;
  __navLock = true;
  const ov = document.getElementById('pageFlip');
  if(!ov){ location.href = url; return; }
  ov.style.display = 'block';
  ov.classList.remove('run');
  void ov.offsetWidth;
  ov.classList.add('run');
  setTimeout(()=>{ location.href = url; }, 260);
}
window.addEventListener('pageshow', ()=>{
  __navLock = false;
  const ov = document.getElementById('pageFlip');
  if(ov){ ov.classList.remove('run'); ov.style.display='none'; }
});

</script>
<div class="verBadge">v2</div>

<div id="pageFlip" aria-hidden="true"></div>

</body>
</html>