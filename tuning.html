<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Ç¶„ÇØ„É¨„É¨Ë®∫Êñ≠ - „ÉÅ„É•„Éº„Éã„É≥„Ç∞</title>
  <style>
    /* „Çπ„Çø„Ç§„É´„ÅØÂâçÂõû„ÅÆ„Äå„Ç∞„É¨„Éº„Ç¢„Ç¶„Éà„Äç„Å®„ÄåÂº¶„ÅÆËâ≤„Äç„ÇíÁ∂≠ÊåÅ */
    body { margin: 0; background: #4a3728; color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }

    :root{
      --vh: 1vh;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }

    /* ===== TOP„Å∏Êàª„Çã„Éú„Çø„É≥ (Êñ∞Ë¶èËøΩÂä†) ===== */
    .nav-back { 
      position:fixed; top:15px; right:15px; z-index:1000; 
      top: calc(var(--safe-top) + 15px); right: calc(var(--safe-right) + 15px);
    }
    .nav-back a{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 16px;
      font-weight: 1000;
      color:#fff;
      background: linear-gradient(135deg, #ff6a6a 0%, #ffb84d 100%);
      box-shadow: 0 8px 0 rgba(0,0,0,0.14), 0 14px 22px rgba(0,0,0,0.12);
      transform: translateY(0);
      transition: transform .08s ease, box-shadow .12s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-back a:active{
      transform: translateY(5px);
      box-shadow: 0 3px 0 rgba(0,0,0,0.14), 0 10px 16px rgba(0,0,0,0.10);
      filter: brightness(0.98);
    }
    .nav-back a:active { transform: scale(0.95); }

    /* ===== iPhone / small screen responsive fixes (UIÂ¥©„ÇåÂØæÁ≠ñ) ===== */
    #guide-msg{
      top: calc(var(--safe-top) + 12px);
      padding: 0 12px;
      font-size: clamp(16px, 4.8vw, 26px);
      line-height: 1.2;
      white-space: normal;
      word-break: keep-all;
    }
    #tuner-nav{
      top: calc(var(--safe-top) + 54px);
      height: auto;
      min-height: 92px;
      font-size: clamp(46px, 12vw, 80px);
    }

    .status-msg{
      font-size: clamp(14px, 4.2vw, 24px);
      margin-top: 2px;
      line-height: 1.2;
    }
    .ui-panel{ display:none; /* hide right buttons: use left labels instead */

      bottom: calc(var(--safe-bottom) + 14px);
      gap: clamp(10px, 3vw, 15px);
    }
    .string-btn{
      width: clamp(54px, 14vw, 75px);
      height: clamp(54px, 14vw, 75px);
      font-size: clamp(14px, 4.2vw, 20px);
      border-width: clamp(3px, 1vw, 4px);
    }
    .string-btn.active{
      border-width: clamp(6px, 1.6vw, 8px);
    }
    .start-btn{
      font-size: clamp(18px, 5vw, 24px);
      padding: clamp(16px, 4.8vw, 24px) clamp(22px, 7vw, 44px);
    }
    
    /* ‚òÖ‰øÆÊ≠£: Ë®∫Êñ≠„Ç´„Éº„Éâ„ÅÆ‰ΩçÁΩÆ„Å®Ë°®Á§∫Â¥©„ÇåÂØæÁ≠ñ */
    #diagnosis-card{
      position: fixed; /* absolute -> fixed „Å´Â§âÊõ¥ */
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%) scale(0); 
      width: 85%; 
      max-width: 450px; 
      max-height: 85vh; /* ÁîªÈù¢„Åã„Çâ„ÅØ„ÅøÂá∫„Å™„ÅÑ„Çà„ÅÜ„Å´Âà∂Èôê */
      background: white; 
      color: #333; 
      padding: 25px; 
      border-radius: 30px; 
      text-align: center; 
      box-shadow: 0 15px 40px rgba(0,0,0,0.3); 
      z-index: 1000; 
      transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
      overflow-y: auto; /* „ÅØ„ÅøÂá∫„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´ */
      -webkit-overflow-scrolling: touch;
    }
    #diagnosis-card.show{ transform: translate(-50%, -50%) scale(1); }

    @media (max-height: 700px){
      #guide-msg{ top: calc(var(--safe-top) + 6px); }
      #tuner-nav{ top: calc(var(--safe-top) + 44px); }
      .ui-panel{ bottom: calc(var(--safe-bottom) + 10px); }
    }

    #screen-tuning { background: linear-gradient(to bottom, #7ab1cc 0%, #a8e6cf 100%); width: 100vw; height: 100dvh; height: calc(var(--vh) * 100); position: relative; }

    /* ==== Index button theme (match index.html) ==== */
    .btnIndex{
      font-size: clamp(18px, 5vw, 24px);
      padding: clamp(16px, 4.8vw, 24px) clamp(22px, 7vw, 44px);
      border-radius: 22px;
      border: none;
      cursor: pointer;
      font-weight: 1000;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 10px 0 rgba(0,0,0,0.16), 0 18px 30px rgba(0,0,0,0.14);
      transform: translateY(0);
      transition: transform .08s ease, box-shadow .12s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btnIndex:active{
      transform: translateY(6px);
      box-shadow: 0 4px 0 rgba(0,0,0,0.16), 0 10px 18px rgba(0,0,0,0.12);
      filter: brightness(0.98);
    }
    .btnIndex .btnIcon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 40px; height: 40px;
      border-radius: 14px;
      background: rgba(255,255,255,0.18);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.25);
      font-size: 22px;
    }
    .btnTuningGrad{ background: linear-gradient(135deg, #25b7ff 0%, #55e7ff 100%); }
    .btnResultGrad{ background: linear-gradient(135deg, #23d57b 0%, #74f3b5 100%); }

    /* Place main layers */
    #screen-tuning > *{ position: relative; z-index: 1; }

    canvas { display: block; width: 100%; height: 100%; }
    #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .start-btn { background: #ff914d; color: white; border: none; padding: 25px 50px; font-size: 24px; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 8px 0 #d97b41; }
    #guide-msg { position: absolute; top: 6%; width: 100%; text-align: center; font-size: 26px; font-weight: bold; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); z-index: 5; }
    #tuner-nav { position: absolute; top: 12%; left: 50%; transform: translateX(-50%); text-align: center; font-size: 80px; font-weight: 900; z-index: 5; height: 120px;}
    .arrow-up { color: #ff5757; text-shadow: 0 0 20px #fff; }
    .arrow-down { color: #5ce1e6; text-shadow: 0 0 20px #fff; }
    .status-msg { font-size: 22px; display:block; margin-top: 8px; line-height: 1.2; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    .ui-panel { position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 10; }
    .string-btn { width: 75px; height: 75px; border-radius: 50%; border: 4px solid #fff; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; color: white; opacity: 0.8; }
    .string-btn.played { background: #888 !important; color: #ccc !important; border-color: #666 !important; transform: scale(0.9); opacity: 0.5; }
    .string-btn.active { border-width: 8px; transform: scale(1.1); box-shadow: 0 0 20px rgba(255,255,255,0.8); z-index: 11; opacity: 1; }
    
    .diag-item { margin: 15px 0; padding: 10px; border-radius: 15px; background: #f9f9f9; }
    .diag-label { font-size: 14px; color: #888; margin-bottom: 4px; font-weight: bold; }
    .diag-value { font-size: 18px; color: #4a3728; font-weight: 900; }
  
/* ===== Diagnosis splash ===== */
.splash{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.splash.show{ display:flex; }
.splash-inner{
  width: min(560px, 92vw);
  background: #fff;
  border-radius: 22px;
  padding: 28px 20px 22px;
  box-shadow: 0 18px 45px rgba(0,0,0,0.22);
  text-align: center;
}
.splash-pop{
  font-weight: 900;
  font-size: 28px;
  letter-spacing: 0.5px;
  color: #ff7a3d;
  text-shadow: 0 3px 0 rgba(0,0,0,0.06);
  transform: scale(0.6);
  opacity: 0;
}
.splash.show .splash-pop{
  animation: popIn 520ms cubic-bezier(.2,1.35,.35,1) forwards;
}
@keyframes popIn{
  0% { transform: scale(0.6) rotate(-2deg); opacity: 0; }
  70% { transform: scale(1.08) rotate(1deg); opacity: 1; }
  100% { transform: scale(1.0) rotate(0deg); opacity: 1; }
}
.splash-btn{
  margin-top: 18px;
  border: 0;
  border-radius: 18px;
  padding: 14px 22px;
  font-size: 18px;
  font-weight: 800;
  color: #fff;
  background: #3fc26b;
  box-shadow: 0 8px 0 rgba(0,0,0,0.08);
  cursor: pointer;
}
.splash-btn:active{ transform: translateY(2px); }

/* ===== Diagnosis extra lines ===== */
.diag-meaning{
  margin-top: 6px;
  font-size: 14px;
  color: #7a7a7a;
  font-weight: 700;
}
.diag-scoreline{
  margin-top: 8px;
  margin-bottom: 8px;
  font-size: 16px;
  font-weight: 900;
  color: #ff7a3d;
}


/* ===== Drumroll ===== */
.splash-pop.blink{
  animation: blinkRoll 120ms steps(1,end) infinite;
}
@keyframes blinkRoll{
  0%{ opacity: 1; }
  50%{ opacity: 0.25; }
  100%{ opacity: 1; }
}
.splash-btn[disabled]{
  opacity: 0.6;
  cursor: default;
  filter: grayscale(0.1);
}


    /* ===== iPhone landscape fix (Ê®™ÁîªÈù¢„Åß„Éú„Çø„É≥„Åå„Éç„ÉÉ„ÇØ„Å´Ë¢´„ÇãÂØæÁ≠ñ) ===== */
    @media (orientation: landscape){
      /* ‰∏ä„ÅÆ„Ç¨„Ç§„Éâ„ÅØ1Ë°å„Å´ÂØÑ„Åõ„Å¶ÁúÅ„Çπ„Éö„Éº„Çπ */
      #guide-msg{
        top: calc(var(--safe-top) + 6px);
        font-size: clamp(14px, 3.6vw, 20px);
        line-height: 1.05;
      }
      #tuner-nav{
        top: calc(var(--safe-top) + 34px);
        min-height: 64px;
        font-size: clamp(34px, 8vw, 56px);
      }

      /* Âº¶„Éú„Çø„É≥„ÇíÂè≥ÂÅ¥„Å´Á∏¶‰∏¶„Å≥„ÅßÈÄÄÈÅøÔºà„Éç„ÉÉ„ÇØ„Å´Ë¢´„Çâ„Å™„ÅÑÔºâ */
      .ui-panel{
        left: auto !important;
        right: calc(var(--safe-right) + 10px);
        bottom: auto !important;
        top: 54%;
        transform: translateY(-50%);
        flex-direction: column-reverse;
        gap: 10px;
      }
      .string-btn{
        width: clamp(48px, 9vw, 60px);
        height: clamp(48px, 9vw, 60px);
        font-size: clamp(13px, 2.8vw, 16px);
      }

      /* „Éç„ÉÉ„ÇØË°®Á§∫„Ç®„É™„Ç¢„ÇíÂ∞ë„Åó‰∏ã„Åí„Å¶‰∏ä„ÅÆÊñáÂ≠ó„Å®Âπ≤Ê∏â„Åï„Åõ„Å™„ÅÑ */
      #neck-area{
        margin-top: 12px;
      }
    }


/* FINAL OVERRIDE: hide right string buttons */
.ui-panel{display:none !important;}

/* DDR4: emoji rendering */
#diag-face, #diag-personality, #diag-ukulele {
  font-family: system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Noto Sans JP",
               "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
}

/* DDR4: face image */
#diag-face-img { width: 110px; height: 110px; }

.diag-subline{margin-top:6px; font-size:18px; font-weight:700; color:#333; text-align:center;}
.diag-mini-title{font-weight:700;}
.diag-personality{margin-top:16px; font-size:32px; font-weight:900; color:#3a2a1a; text-align:center;}


  /* iPhoneÊ®™„Åß„ÄÅË¶ãÂá∫„Åó„Å®Áä∂ÊÖã„ÅåÈáç„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´ */
  @media (orientation: landscape) and (max-height: 430px){
    #guide-msg{ top: calc(env(safe-area-inset-top) + 8px) !important; font-size: 26px !important; padding: 10px 14px !important; }
    #tuner-nav{ top: calc(env(safe-area-inset-top) + 64px) !important; }
  }


/* === DDR6 shared stage alignment patch (tuning) === */
#screen-tuning{
  position: fixed !important;
  inset: 0 !important;
  width: 100vw !important;
  height: calc(var(--vh, 1vh) * 100) !important;
  padding: 0 !important;
  margin: 0 !important;
  overflow: hidden !important;
}
#tuningCanvas{
  position: absolute !important;
  inset: 0 !important;
  width: 100vw !important;
  height: 100% !important;
  display: block !important;
}
/* prevent layout elements from pushing the canvas */
#screen-tuning > *{ position: relative; z-index: 2; }
#screen-tuning #tuningCanvas{ z-index: 1; }
/* top/back button overlay only */
#backToTopTuning{
  position: fixed !important;
  top: 12px !important;
  right: 12px !important;
  z-index: 50 !important;
}
/* remove debug badges if exist */
.version-badge, .debug-badge, .badge, [data-badge], .tuning-badge { display:none !important; }

</style>
</head>
<body>

  <div id="start-overlay">
    <button class="btnIndex btnTuningGrad" onclick="startEverything()"><span class="btnIcon" aria-hidden="true">üéµ</span><span>„ÉÅ„É•„Éº„Éã„É≥„Ç∞„Çí„ÅØ„Åò„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ</span></button>
  </div>

  <div class="nav-back"><a href="index.html">üèùÔ∏è TOP„Å∏</a></div>

  <section id="screen-tuning">
    <div id="guide-msg">1„Åí„Çì„Çí „Å≤„ÅÑ„Å¶„Åø„Çà„ÅÜ</div>
    <div id="tuner-nav">
      <div id="nav-arrow"></div>
      <div id="nav-text" class="status-msg"></div>
    </div>
    <canvas id="tuningCanvas"></canvas>
    
  <div id="diagnosis-splash" class="splash">
    <div class="splash-inner">
      <div class="splash-pop" id="splash-pop">‰ªäÊó•„ÅÆ„Ç¶„ÇØ„É¨„É¨Ë®∫Êñ≠ÁµêÊûúÔºÅÔºÅ</div>
      <button id="btn-show-result" class="btnIndex btnResultGrad splash-btn"><span class="btnIcon" aria-hidden="true">üìã</span><span>ÁµêÊûú„ÇíË¶ã„Çã</span></button>
    </div>
  </div>

<div id="diagnosis-card">
      <div id="diag-face" style="margin-bottom:10px; display:flex; justify-content:center;"><img id="diag-face-img" alt="face" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22120%22%20height%3D%22120%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2260%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2248%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2248%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M40%2070%20Q60%2088%2080%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E" style="width:120px; height:120px;"/></div>
      <h2 style="color: #ff914d;">‰ªäÊó•„ÅÆ„Ç¶„ÇØ„É¨„É¨Ë®∫Êñ≠</h2>
      <div id="diag-title" style="font-size:18px; font-weight:900; color:#ff7a3d; margin-top:6px;"></div>
      <div id="diag-personality" style="font-size:28px; font-weight:900; margin:10px 0 6px; color:#4a3728;"></div>
      <div id="diag-ukulele" style="font-size:18px; font-weight:900; margin:4px 0 10px; color:#333;"></div>
      <div id="diag-scoreline" class="diag-scoreline"></div>
      <div id="diag-meaning" class="diag-meaning"></div>
<button id="btn-details" style="margin:10px auto 0; display:block; background:#fff; border:2px solid #ddd; border-radius:12px; padding:8px 14px; font-weight:900; cursor:pointer;">„Åè„Çè„Åó„Åè</button>
<div id="detail-panel" style="display:none; margin-top:12px;">
        
      <div class="diag-item"><div class="diag-label">„Ç¢„Éâ„Éê„Ç§„Çπ</div><div id="diag-advice" class="diag-value"></div></div>
      <div class="diag-item"><div class="diag-label">ÊÄßÊ†º„ÅÆÁêÜÁî±</div><div id="diag-personality-reason" class="diag-value"></div></div>
      <div class="diag-item"><div class="diag-label">„Åí„Çì„ÅÆ„Çà„ÅÜ„ÅôÔºàÂéüÂõ†„ÅÆ„Éí„É≥„ÉàÔºâ</div><div id="diag-string-state" class="diag-value"></div></div>
<div class="diag-item"><div class="diag-label">„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥</div><div id="diag-cond" class="diag-value"></div></div>
      <div class="diag-item"><div class="diag-label">„É°„É≥„ÉÜ„Éä„É≥„Çπ</div><div id="diag-maint" class="diag-value"></div></div>
      </div>
      <button onclick="resetAll()" style="background:#7ed957; border:none; padding:12px 25px; border-radius:15px; color:white; font-weight:bold; cursor:pointer;">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
    </div>

    <div class="ui-panel">
      <div class="string-btn" id="btn3" style="background:#5ce1e6" onclick="manualSelect(3)">4 G</div>
      <div class="string-btn" id="btn2" style="background:#7ed957" onclick="manualSelect(2)">3 C</div>
      <div class="string-btn" id="btn1" style="background:#ffde59; color:#4a3728" onclick="manualSelect(1)">2 E</div>
      <div class="string-btn active" id="btn0" style="background:#ff5757" onclick="manualSelect(0)">1 A</div>
    </div>
  </section>

<script>
// ==========================================
//  Global Vars & Config
// ==========================================
const canvas = document.getElementById('tuningCanvas');
const ctx = canvas.getContext('2d');
const FREQS = [440.00, 329.63, 261.63, 392.00]; 
const STRING_COLORS = ["#ff5757", "#ffde59", "#7ed957", "#5ce1e6"];
// Game„Å´Âêà„Çè„Åõ„Åü‰ΩçÁΩÆÂÆöÊï∞
const NUT_X = 180; 
const MARK_CX = 125;

let currentTargetIdx = 0;
let audioCtx = null;
let analyser = null;
let micGain = null;
let isMonitoring = false;
let pitchHistory = [];
let ignorePluckUntil = 0;
let pluckHoldCount = 0;
let lastPluckAt = 0;
let prevRms = 0;
let currentRmsVal = 0;
let playedStrings = [false, false, false, false];
let vibrations = [0, 0, 0, 0];
let lastArrowDir = null;

// Noise & Thresholds (Adaptive)
let NOISE_RMS = 0;
let AUTO_CORR_MIN_RMS = 0.010;
let PLUCK_HIGH_RMS = 0.012;
let PLUCK_RISE_RMS = 0.010;
let OK_REL_THRESH = 0.013;
let PLUCK_WINDOW_MS = 1400;

// Env
const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const IS_MOBILE = IS_IOS || /Android/.test(navigator.userAgent);
let __micStream = null;
let __loopToken = 0;

if (IS_IOS) {
  AUTO_CORR_MIN_RMS = 0.0012; PLUCK_RISE_RMS = 0.0016; PLUCK_HIGH_RMS = 0.0020;
} else if (IS_MOBILE) {
  AUTO_CORR_MIN_RMS = 0.0075; PLUCK_RISE_RMS = 0.007; PLUCK_HIGH_RMS = 0.009;
}

// Diagnostics Data Structure
const STRING_NAMES = ["1A", "2E", "3C", "4G"];
let DIAG = null;
let currentStringStartedAt = 0;

function initDiagnostics() {
  DIAG = {
    noiseRms: NOISE_RMS || 0, createdAt: Date.now(),
    strings: Array.from({length: 4}, (_, i) => ({
      idx: i, name: STRING_NAMES[i], startedAt: 0, finishedAt: 0, timeToOkMs: 0,
      okPitchHz: null, okDiffHz: null, okRelDiff: null, flips: 0,
      samplesHz: [], samplesRms: [], rmsPeak: 0, rmsAvg: 0, hzStd: 0
    }))
  };
  currentStringStartedAt = Date.now();
  DIAG.strings[0].startedAt = currentStringStartedAt;
}

function pushSample(idx, hz, rmsVal) {
  const s = DIAG?.strings?.[idx]; if(!s) return;
  s.samplesHz.push(hz); if(s.samplesHz.length>40) s.samplesHz.shift();
  s.samplesRms.push(rmsVal); if(s.samplesRms.length>40) s.samplesRms.shift();
  if(rmsVal > s.rmsPeak) s.rmsPeak = rmsVal;
}

function finalizeString(idx, okPitchHz, targetHz) {
  const s = DIAG?.strings?.[idx]; if(!s) return;
  const now = Date.now();
  s.finishedAt = now;
  s.timeToOkMs = Math.max(0, now - (s.startedAt || currentStringStartedAt || now));
  s.okPitchHz = okPitchHz; s.okDiffHz = okPitchHz - targetHz;
  s.okRelDiff = Math.abs(s.okDiffHz / targetHz);
  
  const hz = s.samplesHz;
  if (hz.length >= 3) {
    const mean = hz.reduce((a,b)=>a+b,0)/hz.length;
    s.hzStd = Math.sqrt(hz.reduce((a,b)=>a + (b-mean)**2,0)/hz.length);
  }
  const rr = s.samplesRms; 
  if (rr.length) s.rmsAvg = rr.reduce((a,b)=>a+b,0)/rr.length;
}

// ==========================================
//  Audio Logic (Full)
// ==========================================
async function startEverything(forceReinit=false) {
  document.getElementById('start-overlay').style.display = 'none';
  if(forceReinit && audioCtx){ try{ await audioCtx.close(); }catch(e){} audioCtx=null; }
  
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  try {
    const audioOpts = IS_IOS ? { echoCancellation:false, noiseSuppression:false } : true;
    const stream = await navigator.mediaDevices.getUserMedia({ audio: audioOpts });
    __micStream = stream;
    
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    micGain = audioCtx.createGain();
    micGain.gain.value = IS_IOS ? 3.9 : 1.0;
    analyser.fftSize = IS_IOS ? 4096 : 2048;
    
    source.connect(micGain);
    micGain.connect(analyser);

    await calibrateNoise(1000);
    prevRms = NOISE_RMS;
    ignorePluckUntil = Date.now() + 700;
    initDiagnostics();
    isMonitoring = true;
    
    requestAnimationFrame(() => updatePitch(++__loopToken));
    document.getElementById('nav-text').innerText = "„Åç„ÅÑ„Å¶„Çã„Çà...";
  } catch (err) { alert("„Éû„Ç§„ÇØ„Åå„Å§„Åã„Åà„Åæ„Åõ„Çì"); }
}

async function calibrateNoise(duration) {
  if(!analyser) return;
  const buf = new Float32Array(analyser.fftSize);
  const start = Date.now();
  const samples = [];
  while(Date.now()-start < duration) {
    analyser.getFloatTimeDomainData(buf);
    let s=0; for(let i=0;i<buf.length;i++) s+=buf[i]**2;
    samples.push(Math.sqrt(s/buf.length));
    await new Promise(r=>setTimeout(r,50));
  }
  samples.sort((a,b)=>a-b);
  NOISE_RMS = samples[Math.floor(samples.length*0.9)] || 0;
}

function updatePitch(token) {
  if (token !== __loopToken) return;
  if (!isMonitoring) { requestAnimationFrame(()=>updatePitch(token)); return; }
  
  const buf = new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);
  let rms = 0; for(let i=0;i<buf.length;i++) rms+=buf[i]**2;
  currentRmsVal = Math.sqrt(rms/buf.length);

  const rise = currentRmsVal - prevRms;
  const now = Date.now();
  if (now >= ignorePluckUntil && currentRmsVal > PLUCK_HIGH_RMS && rise > PLUCK_RISE_RMS) {
    pluckHoldCount++;
  } else {
    pluckHoldCount = Math.max(0, pluckHoldCount-1);
  }
  if (pluckHoldCount >= 2) { lastPluckAt = now; pluckHoldCount = 0; }
  prevRms = currentRmsVal;

  if (now - lastPluckAt < PLUCK_WINDOW_MS) {
    const pitch = autoCorrelate(buf, audioCtx.sampleRate);
    if (pitch !== -1) {
      const target = FREQS[currentTargetIdx];
      let p = pitch;
      while(p < target*0.75) p *= 2;
      while(p > target*1.25) p /= 2;
      if (p > target*0.8 && p < target*1.2) processPitch(p);
    }
  }
  requestAnimationFrame(()=>updatePitch(token));
}

function autoCorrelate(buf, rate) {
  let size = buf.length, rms=0;
  for(let i=0;i<size;i++) rms+=buf[i]**2;
  if (Math.sqrt(rms/size) < AUTO_CORR_MIN_RMS) return -1;
  
  let r1=0,r2=size-1,thres=0.2;
  for(let i=0;i<size/2;i++) if(Math.abs(buf[i])<thres){r1=i;break;}
  for(let i=1;i<size/2;i++) if(Math.abs(buf[size-i])<thres){r2=size-i;break;}
  buf=buf.slice(r1,r2); size=buf.length;
  
  const c = new Float32Array(size);
  for(let i=0;i<size;i++) for(let j=0;j<size-i;j++) c[i]+=buf[j]*buf[j+i];
  let d=0; while(c[d]>c[d+1]) d++;
  let maxv=-1, maxp=-1;
  for(let i=d;i<size;i++) if(c[i]>maxv){maxv=c[i];maxp=i;}
  return rate/maxp;
}

function processPitch(p) {
  pitchHistory.push(p);
  if (pitchHistory.length > SAMPLES_REQUIRED) pitchHistory.shift();
  if (pitchHistory.length === SAMPLES_REQUIRED) {
    const avg = pitchHistory.reduce((a,b)=>a+b)/SAMPLES_REQUIRED;
    const diff = avg - FREQS[currentTargetIdx];
    const rel = Math.abs(diff / FREQS[currentTargetIdx]);
    
    // UI update
    const navText = document.getElementById('nav-text');
    const navArrow = document.getElementById('nav-arrow');
    navText.innerText = `„ÅÑ„Åæ: ${avg.toFixed(1)} Hz`;
    
    // Data Recording
    try { pushSample(currentTargetIdx, avg, currentRmsVal); } catch(e){}

    let okTh = (currentTargetIdx===0) ? 0.008 : OK_REL_THRESH;
    if (rel < okTh) {
      navArrow.innerHTML = "‚ú® OK! ‚ú®";
      navText.innerText = "„Éê„ÉÉ„ÉÅ„É™ÔºÅ";
      finalizeString(currentTargetIdx, avg, FREQS[currentTargetIdx]);
      vibrations[currentTargetIdx] = 40; // visual feedback
      isMonitoring = false;
      setTimeout(()=>markAsDone(currentTargetIdx), 600);
    } else if (diff > 0) {
      navArrow.innerHTML = "‚ñº „ÇÜ„Çã„ÇÅ„Å¶"; navArrow.style.color="#5ce1e6";
    } else {
      navArrow.innerHTML = "‚ñ≤ „Åó„ÇÅ„Å¶"; navArrow.style.color="#ff5757";
    }
  }
}

function markAsDone(idx) {
  playedStrings[idx] = true;
  let next = playedStrings.indexOf(false);
  if (next !== -1) {
    manualSelect(next);
  } else {
    document.getElementById('guide-msg').innerText = "„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ";
    setTimeout(doDiagnosis, 1000);
  }
}

function manualSelect(idx) {
  currentTargetIdx = idx;
  pitchHistory = [];
  lastPluckAt = 0;
  ignorePluckUntil = Date.now() + 500;
  
  // Set current string time for diagnostics
  try {
    currentStringStartedAt = Date.now();
    if(DIAG?.strings?.[idx]) DIAG.strings[idx].startedAt = currentStringStartedAt;
  } catch(e){}

  document.getElementById('guide-msg').innerText = `${idx+1}„Åí„Çì„Çí „Å≤„ÅÑ„Å¶„Åø„Çà„ÅÜ`;
  document.getElementById('nav-arrow').innerText = "";
  document.getElementById('nav-text').innerText = "Âºæ„ÅÑ„Å¶„Å≠‚Ä¶";
  isMonitoring = true;
}

// ==========================================
//  Visual Logic (Game-Matched & Fixed)
// ==========================================
function draw() {
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // Background (shared logic)
  const cy = h / 2;
  // ‚òÖ‰øÆÊ≠£: game.html„Å®ÂÆåÂÖ®„Å´‰∏ÄËá¥„Åô„Çã„Éï„É¨„ÉÉ„ÉàÈñìÈöîË®àÁÆó
  // canvas.width„ÇíÂ§âÊï∞w„Å®„Åó„Å¶‰ΩøÁî®
  const fw = (w - NUT_X - 60) / 12;

  // Neck
  ctx.fillStyle="#6d4c41"; 
  ctx.fillRect(NUT_X, cy-150, w, 300);

  // Frets
  for(let i=0;i<=12;i++){
    const x = NUT_X + i*fw;
    ctx.strokeStyle=(i===0)?"#eee":"#a1887f"; 
    ctx.lineWidth=(i===0)?12:3;
    ctx.beginPath(); ctx.moveTo(x,cy-150); ctx.lineTo(x,cy+150); ctx.stroke();
  }

  // Strings & Labels (Game-matched positions)
  const labels=['1A','2E','3C','4G'];
  for(let i=0;i<4;i++){
    const y = cy + (i-1.5)*75;
    const isActive = (i === currentTargetIdx);
    
    // Label Circle (x=125 from game)
    ctx.beginPath(); 
    ctx.fillStyle=STRING_COLORS[i]; 
    // Active string highlight
    const r = isActive ? 28 : 24;
    ctx.globalAlpha = isActive ? 1.0 : 0.8;
    ctx.arc(MARK_CX, y, r, 0, Math.PI*2); 
    ctx.fill();
    ctx.globalAlpha = 1.0;

    // Text
    ctx.fillStyle="#fff"; 
    ctx.font="bold 16px sans-serif"; 
    ctx.textAlign="center"; 
    ctx.textBaseline="middle"; 
    ctx.fillText(labels[i], MARK_CX, y);

    // String Line
    // Animation for vibration
    const vib = Math.sin(Date.now()*0.2)*vibrations[i];
    vibrations[i] *= 0.92;

    ctx.strokeStyle=STRING_COLORS[i]; 
    ctx.lineWidth= (isActive) ? 8 : 5;
    ctx.beginPath(); 
    ctx.moveTo(NUT_X, y); 
    // Simple vibrate curve
    ctx.quadraticCurveTo(NUT_X + (w-NUT_X)/2, y+vib, w, y);
    ctx.stroke();
  }

  requestAnimationFrame(draw);
}

// ==========================================
//  Diagnosis & Face Logic (Full Data)
// ==========================================
// Face SVG Data (Complete, no truncation)
const faceMapSvg = {
  "üòÉ": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M35%2070%20Q60%2098%2085%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%227%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "üòÅ": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M35%2070%20Q60%2098%2085%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%227%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "ü§©": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%3Cpath%20d%3D%22M18%2026%20L22%2036%20L12%2032%20L22%2032%20L18%2036%20Z%22%20fill%3D%22%237a5cff%22/%3E%0A%20%20%3Cpath%20d%3D%22M102%2028%20L106%2038%20L96%2034%20L106%2034%20L102%2038%20Z%22%20fill%3D%22%2300b3ff%22/%3E%0A%20%20%3Cpath%20d%3D%22M20%2092%20L24%20102%20L14%2098%20L24%2098%20L20%20102%20Z%22%20fill%3D%22%23ff5ca8%22/%3E%0A%20%20%3Cpath%20d%3D%22M100%2092%20L104%20102%20L94%2098%20L104%2098%20L100%20102%20Z%22%20fill%3D%22%237dff5c%22/%3E%0A%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Cpath%20d%3D%22M36%2044%20L41%2058%20L26%2049%20L46%2049%20L31%2058%20Z%22%20fill%3D%22%237a5cff%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%222%22/%3E%3Cpath%20d%3D%22M76%2044%20L81%2058%20L66%2049%20L86%2049%20L71%2058%20Z%22%20fill%3D%22%237a5cff%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%222%22/%3E%0A%20%20%3Cpath%20d%3D%22M35%2070%20Q60%2098%2085%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%227%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "ü•≥": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%3Cpath%20d%3D%22M18%2026%20L22%2036%20L12%2032%20L22%2032%20L18%2036%20Z%22%20fill%3D%22%237a5cff%22/%3E%0A%20%20%3Cpath%20d%3D%22M102%2028%20L106%2038%20L96%2034%20L106%2034%20L102%2038%20Z%22%20fill%3D%22%2300b3ff%22/%3E%0A%20%20%3Cpath%20d%3D%22M20%2092%20L24%20102%20L14%2098%20L24%2098%20L20%20102%20Z%22%20fill%3D%22%23ff5ca8%22/%3E%0A%20%20%3Cpath%20d%3D%22M100%2092%20L104%20102%20L94%2098%20L104%2098%20L100%20102%20Z%22%20fill%3D%22%237dff5c%22/%3E%0A%0A%20%20%3Cpath%20d%3D%22M60%2010%20L92%2042%20L28%2042%20Z%22%20fill%3D%22%237ad7ff%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%223%22/%3E%3Ccircle%20cx%3D%2260%22%20cy%3D%2210%22%20r%3D%226%22%20fill%3D%22%23ff6b7a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2228%22%20r%3D%224%22%20fill%3D%22%23ffd34d%22/%3E%3Ccircle%20cx%3D%2244%22%20cy%3D%2228%22%20r%3D%224%22%20fill%3D%22%23a6ff8a%22/%3E%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M35%2070%20Q60%2098%2085%2070%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%227%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "üòú": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%3Ccircle%20cx%3D%2230%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%3Ccircle%20cx%3D%2290%22%20cy%3D%2264%22%20r%3D%227%22%20fill%3D%22%23ff8aa0%22%20opacity%3D%220.6%22/%3E%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Cpath%20d%3D%22M70%2050%20Q78%2046%2086%2050%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3Cpath%20d%3D%22M40%2072%20Q60%2092%2080%2072%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%3Cpath%20d%3D%22M54%2078%20Q60%2094%2066%2078%22%20fill%3D%22%23ff6b7a%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%224%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
  "üôÇ": "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20120%20120%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23ffe08a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23ffb347%22/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2262%22%20r%3D%2252%22%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%23e59a2b%22%20stroke-width%3D%224%22/%3E%0A%20%20%0A%20%20%3Ccircle%20cx%3D%2244%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%3Ccircle%20cx%3D%2276%22%20cy%3D%2250%22%20r%3D%228%22%20fill%3D%22%233a2a1a%22/%3E%0A%20%20%3Cpath%20d%3D%22M40%2072%20Q60%2090%2080%2072%22%20fill%3D%22none%22%20stroke%3D%22%233a2a1a%22%20stroke-width%3D%226%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E",
};

function getFaceKeyFromText(t){
  const s = String(t||"");
  if (s.includes("„Åç„Åæ„Åê„Çå")) return "üòú";
  if (s.includes("„Åæ„Åò„ÇÅ")) return "üòÉ";
  if (s.includes("„Åç„Çâ„Åç„Çâ")) return "ü§©";
  if (s.includes("„Åí„Çì„Åç")) return "ü•≥";
  if (s.includes("„ÅÆ„Å≥„ÅÆ„Å≥")) return "üòÅ";
  if (s.includes("„Å≤„Åã„Åà„ÇÅ")) return "üôÇ";
  const m = s.trim().match(/^[üòÉüòÅü§©ü•≥üòúüôÇ]/u);
  return m ? m[0] : "üôÇ";
}

function setDiagFaceByPersonalityText(personalityLine){
  const img = document.getElementById('diag-face-img');
  if (!img) return;
  const key = getFaceKeyFromText(personalityLine);
  if (faceMapSvg[key]) img.src = faceMapSvg[key];
}

function doDiagnosis() {
  let d;
  try { d = buildDiagnosis(); } catch (e) { d = {title:"Ë®∫Êñ≠„Ç®„É©„Éº", meaning:"„ÇÇ„ÅÜ‰∏ÄÂ∫¶", scoreline:"", condition:"„Ç®„É©„Éº", maintenance:""}; }

  const splash = document.getElementById('diagnosis-splash');
  const pop = document.getElementById('splash-pop');
  splash.classList.add('show');

  const btnOld = document.getElementById('btn-show-result');
  btnOld.replaceWith(btnOld.cloneNode(true));
  const btn = document.getElementById('btn-show-result');

  btn.disabled = true;
  btn.innerText = "„Åæ„ÇÇ„Å™„Åè‚Ä¶";
  pop.classList.add('blink');

  let ticks = 0;
  const roll = setInterval(() => {
    playTick();
    ticks++;
    if (ticks >= 10) {
      clearInterval(roll);
      pop.classList.remove('blink');
      btn.disabled = false;
      btn.innerText = "ÁµêÊûú„ÇíË¶ã„Çã";
      playTaDa();
    }
  }, 120);

  const showResult = () => {
    splash.classList.remove('show');
    const card = document.getElementById('diagnosis-card');
    card.classList.add('show');

    const base = d || {};
    const condKidRaw = makeKidCondition(base);
    const condKid = convertCodesToGen(condKidRaw);
    const stringState = makeStringState(DIAG);
    const uk = computeUkuleleBodyDiagnosis(DIAG, { condition: String(base.condition||""), maintenance: String(base.maintenance||""), stringState }) || "";
    const pText = computeUkulelePersonality(DIAG, uk, condKid);
    const maintKid = convertCodesToGen(String(base.maintenance||""));
    const adviceText = makeAdvice(pText, uk, stringState);

    const pEl = document.getElementById('diag-personality');
    if (pEl) pEl.innerText = pText;
    setDiagFaceByPersonalityText(pText);

    const ukEl = document.getElementById('diag-ukulele'); // Note: Added hidden logic div if needed, but display handles it
    const meaningEl = document.getElementById('diag-meaning');
    if (meaningEl) meaningEl.innerText = String(base.meaning||"");
    const scoreEl = document.getElementById('diag-scoreline');
    if (scoreEl) scoreEl.innerText = String(base.scoreline||"");
    const advEl = document.getElementById('diag-advice');
    if (advEl) advEl.innerText = adviceText + "\n\n" + condKid + "\n\n" + maintKid;

    btn.removeEventListener('click', showResult);
  };
  btn.addEventListener('click', showResult);
}

// Sound Effects
let _seCtx = null;
function getSeCtx(){ if (!_seCtx) _seCtx = new (window.AudioContext || window.webkitAudioContext)(); return _seCtx; }
function playTick(){
  try{
    const ctx = getSeCtx();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type = "square"; o.frequency.value = 180 + Math.random()*60;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.06);
    o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime + 0.07);
  }catch(e){}
}
function playTaDa(){
  try{
    const ctx = getSeCtx();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(660, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.12);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
    o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime + 0.26);
  }catch(e){}
}

// UIBAR FIX PATCH
(function(){
  function nudge(){ try{ window.scrollTo(0, 1); }catch(e){} setTimeout(function(){ try{ window.scrollTo(0, 1); }catch(e){} }, 50); }
  window.addEventListener('touchstart', nudge, {passive:true});
  window.addEventListener('touchend',   nudge, {passive:true});
  window.addEventListener('click',      nudge, {passive:true});
  window.addEventListener('orientationchange', function(){ setTimeout(nudge, 250); }, {passive:true});
  window.addEventListener('pageshow', function(){ setTimeout(nudge, 250); }, {passive:true});
  setTimeout(nudge, 300);
})();

// === Main Drawing & Resizing Logic (Matched with Game) ===
function applyViewportSize(){
  const vv = window.visualViewport;
  const h = vv ? vv.height : (document.documentElement.clientHeight || window.innerHeight);
  const w = vv ? vv.width  : (document.documentElement.clientWidth  || window.innerWidth);

  document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');

  const screen = document.getElementById('screen-tuning');
  if (screen){
    screen.style.height = 'calc(var(--vh, 1vh) * 100)';
    screen.style.width  = '100vw';
  }

  // IMPORTANT: Game matches logic
  canvas.style.width  = '100vw';
  canvas.style.height = '100%';
  canvas.width  = Math.floor(w);
  canvas.height = Math.floor(h);
}

function draw() {
  // Use canvas dimensions directly (set by applyViewportSize)
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const cy = h / 2;
  // ‚òÖ Game„Å®Âêå„Åò„Éï„É¨„ÉÉ„ÉàÂπÖË®àÁÆó
  const fw = (w - NUT_X - 60) / 12;

  // Neck
  ctx.fillStyle="#6d4c41"; 
  ctx.fillRect(NUT_X, cy-150, w, 300);

  // Frets
  for(let i=0;i<=12;i++){
    const x = NUT_X + i*fw;
    ctx.strokeStyle=(i===0)?"#eee":"#a1887f"; 
    ctx.lineWidth=(i===0)?12:3;
    ctx.beginPath(); ctx.moveTo(x,cy-150); ctx.lineTo(x,cy+150); ctx.stroke();
  }

  // Strings
  const labels=['1A','2E','3C','4G'];
  for(let i=0;i<4;i++){
    const y = cy + (i-1.5)*75;
    const isActive = (i === currentTargetIdx);
    
    // Label Circle (x=125)
    ctx.beginPath(); 
    ctx.fillStyle=STRING_COLORS[i]; 
    const r = isActive ? 28 : 24;
    ctx.globalAlpha = isActive ? 1.0 : 0.8;
    ctx.arc(MARK_CX, y, r, 0, Math.PI*2); 
    ctx.fill();
    ctx.globalAlpha = 1.0;

    // Text
    ctx.fillStyle="#fff"; 
    ctx.font="bold 16px sans-serif"; 
    ctx.textAlign="center"; 
    ctx.textBaseline="middle"; 
    ctx.fillText(labels[i], MARK_CX, y);

    // String Line
    const vib = Math.sin(Date.now()*0.2)*vibrations[i];
    vibrations[i] *= 0.92;

    ctx.strokeStyle=STRING_COLORS[i]; 
    ctx.lineWidth= (isActive) ? 8 : 5;
    ctx.beginPath(); 
    ctx.moveTo(NUT_X, y); 
    ctx.quadraticCurveTo(NUT_X + (w-NUT_X)/2, y+vib, w, y);
    ctx.stroke();
  }

  requestAnimationFrame(draw);
}

applyViewportSize();
if (window.visualViewport){
  window.visualViewport.addEventListener('resize', () => { applyViewportSize(); });
}
window.addEventListener('resize', () => { applyViewportSize(); });
window.addEventListener('orientationchange', () => { setTimeout(() => { applyViewportSize(); }, 250); });
draw();

</script>
</body>
</html>